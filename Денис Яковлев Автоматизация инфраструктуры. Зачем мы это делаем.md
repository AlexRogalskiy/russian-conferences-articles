#### Предлагаю ознакомиться с расшифровкой доклада "Автоматизация инфраструктуры. Зачем мы это делаем?"

**Сам доклад 2016 года. Доклад сециально расшифровал для компаний, которые создают виртуальные машины руками через заявки**

Доклад о том, как мы в компании 2ГИС автоматизировали работу с инфраструктурой.

«Нужно бежать со всех ног, чтобы только оставаться на месте, а чтобы куда-то попасть, надо бежать как минимум вдвое быстрее» (Алиса в стране чудес).

Что эта фраза означает для нас? В условиях жесткой конкуренции, компании должны стремиться доставлять свои продукты до пользователей максимально быстро. Уменьшение параметра time to market — задача многоуровневая. Чтобы ее решить надо менять как процессы разработки, так и инструменты. Важной основой всего процесса разработки является инфраструктура. Чем больше инфраструктура, тем больше с ней проблем, use case`ов и т.д. И если вы все операции с ней выполняете руками, то имеете множество проблем. Одной из них является время, которое разработчик тратит на инфраструктурные вопросы вместо того, чтобы писать бизнес логику.

Поговорим о том:

- Какие проблемы с инфраструктурой стояли перед командами;
- Как от этого страдали процессы разработки и тестирования;
- Как мы внедрили OpenStack;
- Какие у нас есть сценарии использования OpenStack;
- Как автоматизация получила дополнительный толчок в развитии и начали появляться новые внутренние продукты;
- Какие аспекты у нас остались неавтоматизированны.



![](https://habrastorage.org/webt/nu/i0/pe/nui0pe5pmcwn7hufwy1e2ywzb6c.png)

<cut />

![](https://habrastorage.org/webt/as/qx/nx/asqxnxe5gqnx297puo0c6a8fn_s.png)

О себе. Компания 2ГИС. 

![](https://habrastorage.org/webt/ko/hg/ap/kohgapd3pvf9hoinrwh-mpgpyr4.png)

В компании работаю два года.

![](https://habrastorage.org/webt/pe/pj/qw/pepjqwgmhiresqbh344rl36e7ty.png)

Команда Infrastructure and Operations. Мы занимаемся поддержкой внутренней инфраструктуры Web отдела в основном. Недавно к нам еще при засиделись другие команды внутренних продуктов. Мы также отвечаем за эксплуатацию web продуктов компании в продакшене. И мы также занимаемся исследованием и разработкой новых инструментов для облегчения своей жизни и для улучшения жизни наших любимых разработчиков. 

![](https://habrastorage.org/webt/gy/ag/2-/gyag2-xckvwdkl7gdm_7hx6pvwk.png)

Нас всего 9 человек.

![](https://habrastorage.org/webt/c3/uz/zk/c3uzzkplsh7pvj68b9jf3w0x6fw.png)

Сначала поймем инфраструктуру. Почему мы о ней говорим? Что это такое? Когда мы начинаем о ней говорить? 

![](https://habrastorage.org/webt/kt/le/hu/ktlehulbfvgz5uniizdomjk3ksi.png)

C первых моментов работы над продуктом и каким-то проектом у нас возникает вопрос - куда мы будем деплоить? где проверить результаты? где тестировать и так далее. 

![](https://habrastorage.org/webt/vc/f1/og/vcf1ogp7ucfxxsl7fcr0a1ovn4i.png)

Сразу же первый же ответ это естественного локально. Локально потому что очень просто. Разработал на своем ноутбуке, запустил, проверил - все хорошо. Сидишь думаешь - зачем проверять кроме своего ноутбука? У меня все работает.

![](https://habrastorage.org/webt/tv/fo/8s/tvfo8s67s_3qr_lddgivqgufr1q.png)

А если у нас на ноутбуке одна операционная система, а в продакшене крутится другая? Или у нас продукт должен поддерживать несколько операционных систем? 

![](https://habrastorage.org/webt/oi/1v/3v/oi1v3vxhil-0wjcz2nccgv35ane.png)

Кейс не покрывается. То есть разные операционные системы.

![](https://habrastorage.org/webt/cz/az/nd/czaznduqrmabsvhdrj3ghflrjmk.png)

Если мы имеем возможность и мы принимаем волевое решение - говорим что у нас везде Linux. У нас везде Ubuntu там какая-нибудь. Остальное всё от лукавого. Кажется нам что мы решили все свои проблемы.

![](https://habrastorage.org/webt/fk/cm/n4/fkcmn40rxtplxg4wqwwrc5rfqzk.png)

Но простого совпадения операционной системы недостаточно. Нам нужны пакеты определенной версии. 

![](https://habrastorage.org/webt/ur/wk/v2/urwkv23z-j7zrihbl1khhw-w15y.png)

мы думаем как решать эту проблему. И вспоминаем - у нас же изоляция есть. Очень кайфовая штука. слава богу продуктов есть на рынке очень много. Мы берем virtualbox. Создаем виртуальную машину. Накатываем свой продукт. Делаем снапшоты. Мы получили окружение. 

![](https://habrastorage.org/webt/r-/n9/bk/r-n9bka6ertxpzyqxpbhupanpky.png)

Мы развиваемся. Наш продукт становится сложнее. Это уже не просто php приложение с базой. Приложение переросло в распределенную систему. У нас появляются другие продукты. 

![](https://habrastorage.org/webt/6s/i2/hk/6si2hkul51ld2phlv1mpz__aixw.png)

Компания развивается. И у нас появляются новые кейсы использования. Все эти продукты хотят интегрироваться, уметь работать вместе. У нас фичи проходит через несколько продуктов. Нас постоянно просят покажите что вы разработали. Дайте нам где-нибудь это посмотреть. У нас перестает хватать ресурсов на ручные какие-то кейсы, на ручное тестирование. Мы вспоминаем что есть Сontinuous integration, автотесты. Для этого все нужно дополнительный софт. Нам локального окружения даже со всей изоляцией перестает хватать. Здесь появляется инфраструктура. Нам нужно какое-то место куда мы можем задеплоить свои продукты, сделать с ними все что угодно. Показать кому-нибудь. Мы должны как-то управлять. И должно быть это удобно.

![](https://habrastorage.org/webt/pr/vf/uh/prvfuhn624yrkiadhp2hsbuyvfe.png)

Давайте вернемся посмотрим на нашу компанию 2ГИС.

![](https://habrastorage.org/webt/e-/a8/j-/e-a8j-63rvzelvponft65ysnbmw.png)

Это справочник и карты. Можно посмотреть на карте город, поискать организации. 

![](https://habrastorage.org/webt/iy/lp/rc/iylprcfa5i3k3gevbgac_aun2ai.png)

У нас: web продукты, мобайл, десктопное приложение. Команд порядка разных тридцати пяти разных размеров. 

![](https://habrastorage.org/webt/g4/za/ei/g4zaeixca9qx5xbjlb7c7pdhg-e.png)

Какие проблемы у нас были с инфраструктурой? На конец 2013 года у нас использовался proxmox. Это система управления виртуализацией. С помощью нее можно создавать либо KVM виртуальные машины, можно создавать OpenVZ контейнеры. Но это все делается руками через интерфейсы. Для полноценного функционирования еще нужно зайти в виртуальную машину и сконфигурировать сеть, dns. 

![](https://habrastorage.org/webt/jh/un/um/jhunumwvdccmklzouppnrkzu3ns.png)

Поэтому у нас какое-то время flow нашей разработки выглядел следующим образом. Я как разработчик завожу ticket админам. Админы когда у них будет время дойдет создают виртуалку. Выдают IP-адрес, логин, пароль. Но если мне нужно переразвернуть эту виртуалку, то мне нужно опять идти к админам, которые уже на меня так подозрительно смотрят. Говорят -  парень сколько можно?

![](https://habrastorage.org/webt/hm/1a/ls/hm1alsxmnf5lmpfgtmminlzvtdq.png)

Не было разделения по проектам. Был набор виртуалок на нескольких серверах где админы руками и создавали. Была большая вероятность человеческой ошибки. Можно было перепутать IP-адрес или удалить не ту виртуальную машину. Очень-очень много таких кейсов. И непонятна ответственность за виртуальную машину. Разработчики ответственность не несут, админы тоже не парятся. Непонятно виртуалка она уже кому-то нужна или про нее все уже давно забыли и не знают о ней. 

![](https://habrastorage.org/webt/3y/9e/pw/3y9epwkzviqkgupe0toc_9pbioo.png)

Плюс там слабый API. Плагины либо платные либо на перле. 

![](https://habrastorage.org/webt/vb/pq/9y/vbpq9yat0roahzxzqzhca9i23hy.png)

Но помимо проблем у нас было еще кое-что полезное. У нас было свое железо, на котором все это крутилось. У нас системные администраторы большие молодцы, которые умеют это железо готовить, за ним ухаживать, его правильно закупать. И у них какой-то опыт был работы с виртуализацией.

![](https://habrastorage.org/webt/kn/tl/ic/kntlic-tm5c91z9ogulyo9zweqa.png)

Мы начали думать. Какое бы решение нас устроило. Как должна выглядеть наша инфраструктура чтобы не мешать процессу разработки. А наоборот должна помогать. Какой у нас список требований получился в результате исследования.

Эффективная утилизация железо. Мы не хотим иметь бесхозные виртуальные машины. Мы не хотим просто греть воздух в дата-центре. 

Мы хотим иметь командные ресурсы чтобы команда взяла на себя ответственность за те ресурсы, которые она использует. И прилежно что ли к ним относилась.

Мы хотим чтобы решение было модульным чтобы набрать только необходимые нам сервисы. При необходимости в дальнейшем развитии хотелось бы расширить.

Решение должно быть легко дорабатываем. Если появляются какие-то специфические нужды, то мы могли возможность доработать решение под наши специфичные нужды. Чтоб удобно было с ним работать.

Нам нужен не только пользовательский интерфейс, нам нужен API чтобы писать обвязки свои и управлять инфраструктурой. 

Мы хотим изолировать команды и особенно команду нагрузочного тестирования. Хотелось бы чтобы она вообще не мешала остальным.

![](https://habrastorage.org/webt/fg/nc/xf/fgncxfm2nnnkbfslzo0nnl35cfk.png)

Какие у нас варианты были. Мы посмотрели на вариант публичное облако: AWS и прочее. Вариант привлекательный тем они что берут на себя практически все вопросы, связанные с инфраструктурой. Но отталкивает тем что оплата в долларах. Ситуацию с долларами объяснять не надо. Все об этом знают. Можно было взять и заплатить много денег вот этим обозначенным компаниям. Но тут тоже опять же ситуация с долларом. Не очень хотелось какой-нибудь vendor-lock получить. Третий вариант, на которой мы посмотрели это что у нас есть на рынке open source. Какие решения у нас предлагается? Железо у нас есть свое и попробовать что-нибудь из этого open source заюзать.

![](https://habrastorage.org/webt/qk/ii/sw/qkiiswbwmdnunz_qpef2z7vpdso.png)

Вот так и в итоге наше все исследования и эксперименты прочее нас привели к софтинке называемый OpenStack. Софтинке конечно это слишком грубо звучит. 

![](https://habrastorage.org/webt/o9/-8/rd/o9-8rd06u7nff83ufgzbdagqage.png)

OpenStack это полноценное программное обеспечение по сути это набор сервисов для построения публичного или приватного облака. OpenStack это open source решение. Все сервисы написаны на питоне. Каждый сервис отвечает за свою задач, имеет свой API. 

![](https://habrastorage.org/webt/vw/x9/gm/vwx9gmn5e_jp0m9wcer_ajrj4e0.png)

И выглядит это вот так вот. Запомните эту картинку. Дальше потом к ней вернемся. Есть шаренные (общие) сервисы. Есть сервисы по назначению: Compute, Networking, Storage. И наш application или юзер работает с этими сервисами.

![](https://habrastorage.org/webt/1i/eg/1e/1ieg1ek2kopjwzgf_3_tsatwdtg.png)

Решение open source. Релиз проходит раз полгода. В релиз включаются базовые компоненты. Каждый релиз включаются новые компоненты, которые изначально появляются от в этом инкубаторе. Они там какое-то время проводят, там фиксят баги, стабилизирует и прочее. И в какой-то момент сообщество принимает решение что этот компонент включить в состав базовых компонентов со следующего релиза. Также много различных рассылок, встреч, конференций. Самая большая конференция это OpenStack Summit. Проводится каждый год. И на последнем OpenStack саммите было порядка четырех или пяти тысяч участников. Очень большой такой ивент. Много докладов.

![](https://habrastorage.org/webt/ac/ms/go/acmsgowharhocay2-ypwcuhhwky.png)

Контрибьютят в это решение очень много народа. Здесь я привел только список из таких топов. Этот список достаточен чтобы понять насколько проект серьезен и какие компании и сколько ресурсов в него вкладывают. 

![](https://habrastorage.org/webt/mu/jd/i_/mujdi_xe4zcvroyq_czco2ccwvm.png)

Как мы решили наши проблемы с инфраструктурой. 

- Один из компонентов OpenStack это scheduler, который выбирает хост на котором будет создан виртуальная машина. 
- Теперь у команды есть свои собственные ресурсы. Это количество CPU, памяти и прочее. Мы избавились от этого сценария создания виртуалки по tiket (заявки).
- OpenStack это набор сервисов то есть. Мы взяли только базовый набор, который обеспечивал наши нужды.
- Так как OpenStack это open-source, то есть возможность его дорабатывать.
- У каждого сервиса есть API. Есть питоновские билдинги. То есть достаточно просто с каждым сервисом взаимодействовать и писать свои какие-то обвязки.
- Изоляция. Мы можем изолировать команд нам по проектам, по aggragation зонам, по сетям и прочее. 

![](https://habrastorage.org/webt/db/th/sr/dbthsrjfwry6lmqpejowmzephv4.png)

Разработчики команд получили инфраструктуру по требованию (infrastructure as service). Как это выглядит.

![](https://habrastorage.org/webt/e7/q8/6y/e7q86ycmgunc1i0clqgi13hosza.png)

Есть два понятия Stack и шаблон. Stack это набор облачных ресурсов: виртуальные машины, сеть, dns записи и прочее. Шаблон это описание этого Stack. В случае OpenStack это обычная YAML файл. Здесь часть файла. Тут написано что есть такая сущность как сервер с внутренним типом OS Nova сервер. Для его нормальной работы нужен IP адрес и dns запись. Здесь на вход принимаются параметры имя, flavor - это описание ресурсов, которые нужно этому серверу. Image операционная система. key_name - какой публичный ключ положить при развертывании сервера. У нас все эти шаблоны лежат в репозитории каждой имеют в git. Каждый имеет доступ. Каждый может прислать pull request.

![](https://habrastorage.org/webt/ue/cn/yb/uecnybkseypqwackevttdl_urym.png)

И создание Stack выглядит следующим образом. Heat эта компонента OpenStack, отвечающая за оркестрацию. Мы говорим это в данном контексте. Это отличная утилита, которую мы установили себе. Мы говорим дорогой heat, создай нам Stack с таким именем, вот описание ресурсов, которые нам нужны для создания этого Stack. И вот входные данные, которые требует наш шаблон, который описывает наш стек. Мы это в heat загружаем. Он там шуршит какое-то время, создает нам все необходимые ресурсы у себя внутри. И также мы в этом шаблоне вот здесь вот мы можем указать output. Когда heat создал Stack, он может вывести информацию: ip-адрес, доступ и остальное что мы попросим. Дальше уже можем применять эту информацию для дальнейшей автоматизации.

![](https://habrastorage.org/webt/8o/rw/wr/8orwwrabyca0-nmfxfeg8s9yrxg.png)

Для того для того чтобы вы не подумали что OpenStack это просто и дешево, я расскажу на каком железе у на работает OpenStack. Контрольная панель крутится на 3 инфра-нодах. Это железные сервера вот с такими от ресурсами. Это рекомендованная конфигурация для отказоустойчивых.

![](https://habrastorage.org/webt/kv/r1/nv/kvr1nvsoifsdsnvnf9lnyxrcdvw.png)

Также у нас есть две KVM network-ноды, которые обслуживают нашу сеть.

![](https://habrastorage.org/webt/ql/gw/oh/qlgwohgkf6ry1g_iiy8ousjoaum.png)

Командные ресурсы у нас крутятся на 8 compute-нодах. Они у нас поделены на 3 агрегационные зоны. Одна compute-нода выделена на зону для нагрузочного тестирования. Там создаются сервера только от команды нагрузочного тестирования. Чтобы не мешать остальным. У нас есть агрегационная зона для нашего внутреннего проекта автоматизации тестирования GUI. У него определенные требования. Он расположен в отдельной агрегационной зоне. Все остальные наши девелоперские окружения, сервера, тестовые окружения крутятся в третьем большом агрегационной зоне. На нее у нас уходит 6 compute-нод.

![](https://habrastorage.org/webt/uq/qh/wb/uqqhwbqsf0aqg4xl4hibkvdjcyw.png)

Мы крутим порядка 350 виртуалок на все команды.

![](https://habrastorage.org/webt/q9/u5/nw/q9u5nwuk8lajoby71bgk8ttftea.png)

Что мы поняли когда мы уже прошли какой-то путь. Для деплоя и для сопровождения вот этого программного обеспечения нужна команда. Команда в зависимости от ваших ресурсов. 

![](https://habrastorage.org/webt/8b/cs/eb/8bcsebrogamrpv-i4aevm6brqsu.png)

Команды должны обладать определенной компетенцией. 

В первую очередь это естественно Ansbile. Деплой OpenStack написан на Ansbile. Есть проект [OpenStack-Ansible](OpenStack-Ansbile). Если вы захотите дописать OpenStack-Ansible под свои нужды, то нужно чтобы люди, которые будут этим заниматься, владели Ansbile.

Опыт виртуализации. Нужно уметь виртуализацию готовить, нужно тюнить. Понимать как она работает.

То же самое сетью. 

То же самое с backend-сервисами, которые использует OpenStack для своей работы. Эта база MySQL Galera и RabbitMQ в качестве очереди.

Понимание как работает DNS. Как его настроить.

OpenStack написан на питоне. Нужно уметь читать код. В идеале нужно уметь патчить. Искать в комьюнити фиксы. Уметь дебажить код. Это все очень полезно. Если команда имеет такой подход, умеет пользовался подходом как Infrastructure as code, как например ansible все изменения хранят в коде, то у них не будет проблем, которые возникают при настройке руками. 

Continues integrations. В набор сервисов OpenStack входит такой сервис как [tempest](https://docs.openstack.org/tempest/latest/). В нем все тесты написаны на все компоненты. Если мы меняем конфигурацию, запускаем отдельный диплой в All-In-One инсталяции и прогоняем [tempest](https://docs.openstack.org/tempest/latest/) - смотрим не отвалилось ли что-нибудь у нас. Настроен CI и команда должна это понимать и должна уметь все это настроить.

![](https://habrastorage.org/webt/tf/ys/f5/tfysf5fh56lvcmsdh8ae1oqupnu.png)

Потому что выглядит все просто и привлекательно данного.

![](https://habrastorage.org/webt/pn/yw/d3/pnywd3j3eyzqffrnz3egw_wfyg8.png)

Но когда начинаешь больше вникать в нее, то понимаешь что на самом деле все выглядит вот так вот. Это для кого то может быть сюрпризом. 

![](https://habrastorage.org/webt/5p/9d/uj/5p9dujin57sxp6qs8akdiw3fgxw.png)

Внедрение OpenStack это не только техническое решение. Помимо этого нужно уметь продать, уметь объяснить командам новую парадигму того как они теперь работают, какие бенефиты это приносит. Как правильно с этим работать чтобы получить какой профит. Мы писали много документации. Документация вида quickstart (быстрый запуск), first steps(первые шаги). То есть что нужно сделать чтобы быстро облегчить себе жизнь и не за тратить на это много времени.

Мы проводили TechTalk, мы рассказывали, делали темы, показывали, говорили вот смотрите теперь ваш продукт вы можете получить следующим образом. буквально вот пишем шаблон, запускаем. Все достаточно просто. Не надо теперь ходить к админам и что-то у них там просить.

В особо таких сложных случаях когда проект сложный, у него куча кейсов, мы приходили в команды, работали непосредственно с командами. То есть как-то попытались им помочь в автоматизации процессов. Настраивали все командам. Заводили себе какие-то баги. Понимали что мы что-то там не неправильно настроили. В общем плотная работа с командами. 

![](https://habrastorage.org/webt/rh/kv/xo/rhkvxoaqqbbicptnizpn1iouykg.png)

Мы получили быстрый деплой продуктов. Раньше чтобы получить продукты нужно было совершить много ручных действий, взаимодействовать с многими людьми. Сейчас мы получаем создание Envinronment (Окружение, сервера) по кнопке. А если у проекта написан и работает deploy , мы получаем deploy по кнопке или новые Envinronment (Окружение, сервера) с установленным продуктом. 

Отсутствие нормальной инфраструктуры было блокером для некоторых команд в плане реализация процесса CI внутри команды. Мы проблемы с инфраструктуры решили, команды подняли по CI серверу, настроили pipeline, в pipeline создаются виртуальные машины. В общем дали толчок в развитии этих процессов. 

Также помогли некоторым внутренним продуктам, которые используют инфраструктуру для автоматизации тестирования. VM Master - продукт, который тестирует наш онлайн. Ему нужно поднять много виртуальных машин чтобы с разных браузеров зайти на сайт, пройти какие-то шаги чтобы понимать что у нас онлайн работает во всех известных браузеров. То есть ему очень помогли. 

Приятный бонус что разгрузили админов (сами себя). Потому что в какой-то момент деятельность по созданию виртуальной машины начала занимать космическое время. И все начали нервничать. Сейчас мы занимаемся интересными вещами, сложными продуктами. От рутинной задачи мы избавились.

![](https://habrastorage.org/webt/ho/0f/4z/ho0f4zmwursgmh8xbvcx8anakg8.png)

Вопросы?

Вопрос: Сколько времени понадобилось чтобы внедрить OpenStack?

Ответ: Вопрос сложный потому что у нас был процесс, который может вместиться комедийный сериал. У него порог вхождения высокий. Осмысливали всю нашу инфраструктуру, искали решение - ушло три месяца. Потом мы за месяц где-то раскатали первую инсталляцию. Добавили туда парочку проектов. Они там пожили. Потом случился человеческий фактор - отстрелили голову этой инсталляции. Мы поняли что отсутствие отказоустойчивости плохо. Потом мы ждали железо. 

Вопрос: пользуетесь ли платной поддержкой?

Ответ: нет, не пользуемся.

Вопрос: Какую версию OpenStack используете?

Ответ: Версия OpenStack называются словами. Сначала был Juno, потом мы обновили до Liberty.

Вопрос: Создаются ли виртуальные машины в pipeline Сontinuous integration?

Ответ:  Сборка в Jenkins может вызвать Heat и создать виртуальную машину.

Вопрос: сталкивались ли вы с проблемами шаринга ресурсов? Грубо говоря 2 виртуалки находятся на одной физическом сервере. Одна из них начинает грузить диск, например база данных. Если сталкивались, то как решали?

Ответ: С проблемами шаринга ресурсов не сталкивались. Продукты друг друга особо не мешают. Мы разнесли по сценариям. Если нужно запустить тяжелый сценарий, прогнать нагрузочные тесты, То нужно идти к команде нагрузочного тестирования и они запускают нагрузочное тестирование. 

Вопрос: нагрузочное тестирование сразу вынесли в отдельную агрегационную зону или натолкнулись на какие-то проблемы?

Ответ: Приходили сотрудники и говорили что OpenStack тормозит. Мы начинаем разбираться. Оказывается у нас появилась команда нагрузочного тестирования. И команду нагрузочного тестирования вынесли в отдельную агрегационную зону.

Вопрос: У нас большой поток тестов. И тесты находятся в очереди и ждут своих ресурсов. Поможет ли OpenStack в качестве менеджера ресурсов для автотестов?

Ответ: У нас такого кейса нет. В OpenStack есть планировщик. Он управляет ресурсами.

Вопрос: На сколько бы сложен переезд со старой инфраструктуры в OpenStack? 

Ответ: Это был очень веселый процесс. Почистили ненужные виртуальные машины в proxmox. Перенесли виртуальные машины в OpenStack. 

Вопрос: Что такое DevOps?

Ответ: DevOps это идеология, направленная на то чтобы как можно быстрее доставлять продукты кастомерам. Все процессы в компании, инструментарий, мышление и взаимодействие между командами должны быть выстроены вокруг этой цели.
