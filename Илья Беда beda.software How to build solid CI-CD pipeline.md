**Здесь переводится видео в статью Ильи Беда из beda.software "How to build solid CI-CD pipeline"**

Ссылка на видеодоклад https://www.youtube.com/watch?v=YG8Zky0PL1I

**Текст сделан из субтитров. Буду очень благодарен в форматировании текста, его вычитки. Для этого достаточно знать русский язык.
Присылайте свои pull request или присылайте текст на почту patsev.anton[собака]gmail.com**


всем привет и как я уже сказал я буду рассказывать как взять и просто удобно и классно доставить код на орви чтоб там все это заработало в общем как делать continuous delivery сначала немного про меня разработкой занимаюсь уже порядка девяти лет за все это время я поработал различных компаниях но никогда это не были какие-то продуктовые компании которые делали какой-то большой продукты мне вообще интересно узнать кто из присутствующих за не работает именно в продуктовой компании поднимите руки ну наверно половина где-то ну значит весьма вторая половина работает в консалтинге и занимается заказной разработкой поднимите руки кто работает в консалтинге а где тогда все остальные работают не работают и ходят по конференциям но это классно вот собственно я из консалтинга и задачи которые обычно передо мной стояли они не несколько отличались от того что мы привыкли видеть в продуктовых компаниях это не какая-то супер большая нагрузка это скорее много много проектов которые нужно унифицировать и автоматизировать максимально все процессы вот опять же небольшое замечание я всегда в том или ином роде являлся соучредителем бизнеса в котором участвовал вот ну а сейчас у меня просто своя компания называется беда software вот и мы занимаемся консалтингом разработкой все классно ладно поехали дальше я начну с небольшой истории как вообще я докатился до того что начал заниматься дива псам и выкладывать код в продакшен исторически когда то давным давно когда ещё учился в институте я работал самым обычным админом который в организациях настраивал там серверах где можно было там файлики пошарить друг другу и тогда все управление инфраструктурой была простой она была ручное если нужно было сделать какие-то там серьезные изменения на выходных звались друзья там пару каких-то бутылок с пенным напитком все это там конфигурировал ась настраивалась причем не то что там по ssh просто там монитор подключается к серверу но как серверу коробка это под столом стоит вот этом терминале написал о заработала хорошо в понедельник все пришли а там оказывается с винды на ленку все было не равана это была определенная веселье и то что управление инфраструктурой было ручной она сыграла со мной злую шутку потому что потом когда я уже пришел работает пришел вайп разработку и начал заниматься непосредственно программированием я по инерции продолжал всего про инфраструктура делать ручном режиме но ничего хорошего из этого не выходила и появились попытки что-то автоматизировать написали скрипт и на фабрик потому что вся разработка как бы велась на python и но и логично взять фабрик и в таком полуавтоматическом режиме то что можно автоматизировать она вот этими скриптами делалось потом зашел какой-то конфиг ручками то правил и вроде всё нормально и вот в эти времена я повстречался с таким ужасным монстром с которым я вот сейчас хочу познакомить вот вот сидишь на что-то такое пишут код какое-то дело и жку это интересную задачу к тебе приходят двое таких ребят нас clicker не будет работать сегодня приходит они говорят привет мы тут сделали как сайт и в общем его нужно на сервер доставить за тепло и ну ладно ничего нужно делать заходим там что-то запускаем за тепло или работаем дальше привет мы как сайт сделали все нормально но забыли там ссылку на группу вконтакте обновить за deploy не совсем приятно но приходится делать нечего сидишь и работаешь дальше как вы думаете привет но мы группа нам и мы ссылку на группу вконтакте обновили но в минуту и короче нужно опять за деплоить и когда вот этот злобный монстр к тебе приходит ты понимаешь что скорее все это занимаешься чем-то не тем потому что это какая-то изматывающая рутина который ты бы не хотела заниматься тебе хочется делать какие-то интересные задачи а ты такой бутылочное горлышко все в тебе утыкаются и нужно как то решать эту проблему эта рутина изматывает и нужно как-то от нее избавиться решение в лоб самая первая которая только можно предложить это обычное делегирование вот найдешь кого-то кто вместо тебя эту рутину будет делать кто знает анекдот про двух сантехников ну но если конкретизировать тогда уже спойлер будет ну я надеюсь в общем я сейчас расскажу происходит коммунальная авария приезжаю двое таких ребят первые это дядя ваня вот он такой солидный сантехник он знает все как работает и его стажер санек смотрят вот этот люк там что то вот это вот булькает всех короче какой-то трэш вообще ну делать нечего там дядя ваня такой хоп-хоп рукава засучил ныряет туда там что-то 1 1 ключ на 15 ну подает что-то крутит бог бог нам разводной ключ разводной ключ то там щелкнуло треснула там все очистилось вылазит в весь вот во всем вот в этом такой rds санек sanyok учись а только будешь ключи подавать мораль этой истории в следующем надо лисоньку вообще вот это вот все может быть его устраивает то что есть и ненужный и не хочет вот это все погружаться это вполне логично пробую проблема того чтобы дать какую-то передать ответственную задачу она никуда не денется но даже если вдруг вы нашли такого человека он готовы ним заниматься он супер ответственный вымыта поручаете то не всё так просто он все равно остается человеком и могут произойти такие ситуации что допустим эти начинает плохо чувствовать или он заболел или какие-то семейные проблемы и потом как то вот так вот раз ее что-то что-то пошло не так вот но так значит делегирование это только половину проблемы решит как ты себя эту рутину сбросил но в долгосрочной перспективе как бы не намного лучше все стало поэтому нужно что-то дополнительно искать и второе решение которое логично следует она автоматизация ну все мы хотим чтобы появился какой-то такой добрый робот который будет все это делать плюс у и работает 24 на 7 и зарплату платить не нужно общем классика все это сделал отдыхаешь занимаются тем что тебе интересно а все вот рутина на роботах и они все это делают вот и на самом деле с процессом выкладки кода в продакшен можно сделать точно так же можно сделать таких роботов который за вас это будет делать но только вам понадобится не один робот а целых три и сейчас мы начнем с ними по очереди знакомиться я называю этих роботов команда командой авто тепло и но перед тем как мы начнем с ними знакомиться чуть-чуть информации по поводу автоматизации чтобы что-либо успешно автоматизировать сначала нужно провести определённую подготовительную работу потому что скорее всего в те процессы которые у вас сложились исторически они не могут быть просто так взятое легко превращены в полностью автоматизированный процесс нужно их как-то подготовить нужно подточить чтоб она вот так вот шаблон на друг другом состыковалось и начала работать вот и дальше мы сталкиваемся со следующей проблемы есть такое известное высказывание что там за 80 что 80 процентов фича делается за 20 процентов времени оставшиеся 20 тысяч 80 процентов времени нужно делать это немного перефразировал вот таким вот образом что 20 процентов в нестандартных печь создают больше всего проблем и вот эти вот 20 процентов нестандартных fitch это вот самая большая проблема автомате зато raw потому что вот выкинешь их и все будет хорошо но их нельзя выкидывать потому что это самая соль вот то что должно быть и нельзя этого так делать как как правило это какие-то бизнес специфичные задачи что-то нестандартное ну и в конце концов наиболее такие опытные программисты их мотивирует как раз решение вот этих нестандартных задач чтобы что-то вот эдакая выдумать сделать потом и на конференции можно рассказать и его пан source выложить возможно вот поэтому нам нужно как-то найти баланс и соблюсти компромисс между тем что с одной стороны мы должны позволить разработчику использовать те технологии и те инструменты которые он хочет с другой стороны это все должно быть вот так вот очень друг с другом хорошо стыковаться и работать вот и решение на самом деле есть она появилась довольно давно и все про него слышали потому что это конечно же докер вот еще вчера там на докладах спрашивали кто слышал про докер этом вся аудитория поднимала руку поэтому детали идут останавливаться не надо вот и докер это прям супер технология потому что он позволяет сделать следующие неважно на чем у вас написано приложение не важно какие у вас технологии это руби или python или но доджерс или на хоть на хаскеле вы написали вы можете это засунуть в контейнер разработчик сам пропишет какие зависимости поставить что там куда положить и это будет запускаться стандартным образом только с помощью докера это очень большой шаг навстречу автоматизации следующее что позволяет продолжить вот эту унификацию это директива докер файл entry point которую многие почему-то недооценивают и не использует нужно обязательно использовать потому что благодаря директивы entry point вы можете сказать что будет запускаться по умолчанию и мы можем договориться что когда у нас команда разработки делает образ и если мы его запускаем без каких-либо параметров это запуск продакшен режиме что такое запас production режиме любого проекта но это значит на каком-то порту за заранее которое договорюсь допустим 8000 запускается веб-серверы туда нужно трафик прокси ровать как это запускается какой командой не важно потому что это все три помните уже все находится и работает есть еще два важных замечаний на который я хочу обратить внимание при работе с докером и первое заключается в том что нужно не только тепло и такер мной разрабатывать в докере потому что вас движение должно идти с двух сторон и если разработка у вас построена по другому то у вас команда девелоперов не будет поднимать тех проблем которые происходят в продакшене они могут конфигурировать как-то неправильно они могут писать куда-то в какую-то файловую систему и тем самым делать контейнер не встретилось и это все проблемы проще всего избежать так чтобы вся разработка велась в докере и сейчас это никакая не проблема потому что докер поддерживается практически везде тех проблем которые были там год назад когда что-то там авто комплит какой-то не работал а то сейчас нету поэтому разрабатываете в докере и вторая важная деталь в том что никогда не нужно собирать контейнеры в продакшене вот для кого-то это очевидно для кого то нет и плюс те инструменты которые позволяют запускать докер части docker machine они немного поощряю делать вот эту сборку образов продакшене проблема тут очень простая когда у нас собирается образ выполняется какой-то код ставится какие-то зависимости и тут просто из своего опыта я могу привести пример как в приложении на ноги джесс в зависимости библиотеки и матч мин была какая-то опечатка там было форк бомба это все вот так вот вытекала вся память выжрала и все падало на продакшен такого не хочется допустить поэтому лучше все сборки делать изолирована на каком-то сервере который все это соберет засунет бриджес три и потом production заберет оттуда ну и плюс если на продакшене собирать как бы это дополнительная нагрузка но это совсем не надо никому вот он наш первый член команды of на тепло и фото докер мы с ним знакомы мы знаем как у на наши проект наш программный код подогнать чтобы его можно было запустить там где угодно дальше после того как мы упаковали приложение нам нужно как-то доставить его в продакшен нам нужен какой-то инструмент инструмент вот который будет собственно в продакшн эти контейнеры забрасывать и не там будет крутиться и давайте посмотрим что общие для этого есть логично предположить что раз мы уже используем докер то почему бы не доставлять это в продакшн с помощью докер машин но тут не все так однозначно есть определенные проблемы с которыми вы сталкиваетесь так или иначе поэтому кому-то это подойдет кому то нет первая проблема докер машин заключается в том что если вы взяли и сконфигурировали сервер с какого-то определенного компьютера то на другой компьютер это уже не перенести да можно там подскочить конфиге сертификате какие-то скопировать но этого нет стандартной документации и не просто так потому что там весь определенные проблемы опасность вот ну даже если вы как вы думаете черт с ней безопасности я пока там все я принимаю этот риск остается вторая проблема вторая проблема заключается в том что вот докер машин кроме докера вам как бы больше не поставит ничего и если вы хотите сделать какое-то дополнительное конфигурирование сервера то это придется делать как-то сбоку как-то дополнительно например вы хотите чтобы у вас логе с машина отправлялись тут то что короче принимаете слова отправлялась на какой-то сервер где вы можете логе просматривать и докер соответственно конфигурируется чтоб он все слог все это писал этого придется сделать дополнительно docker machine с этим не поможет плюс если какие то опять же дополнительные вещи нужно делать никак не получится поэтому смотрим что может быть дальше решение в лоб это баш на нем я как бы останавливаться даже не буду потому что больше 500 строк на баше к сожалению кроме мусорке никуда это отправить нельзя идем дальше copy стран и фабрик это инструменты которые позволяют писать вот этот поправлять писать скрипты на языке более приятным чем баш это либо руби либо python вот но остается все равно одна проблема потому что то что вы напишете на этих языках эти скрипты они остаются императивными и вам их нужно как-то либо жить есть компании вполне даже серьезные большие которые используют инструменты для тепло и говорят ну все нормально у нас устраивает но меня не устраивает потому что ладно вы пишете программный код императивные отлаживайте его когда вы пишете код который управляет инфраструктурой отлаживать его гораздо сложнее плюс если вы описываете инфраструктуру вам очень важно чтобы ваши инструменты были дым патентными потому что вы хотите просто писать что вот мне нужно нужен вот такой сервер вот его описание сделай его они так что вот если так приди туда и тут сюда сюда появляются какие-то iv checker если в этом файлики есть такая строка то можно добавлять не будем а если нет мы будем добавлять код растет увеличивается усложняется усложнение отладки а отладка это изначальная проблема поэтому где-то жив не рекомендую использовать рекомендую использовать не что иное как средство управления конфигурации ну я думаю все знают что такое средство управление конфигурацией значит такое средство крайне конфигурации ну практически все вот в общем средства крайне конфигурации как раз обладает вот этими важными свойствами они декларативные дам патент на и вы описываете в каком-нибудь ямал файле что вам нужно вот допустим не на сервере нужно запустить контейнер там с такими параметрами дальше это будет я покажу как вот есть различные имплементации то есть configuration management system это просто как парадигма есть инси был шеф паппет solstic можно использовать плюс-минус то что вам интересно но так как исторически я все время был поэтому разработчикам я выбрал н символ потому что он как бы на по это не написан вот опять же детальная ничего рассказывать не буду это тема для отдельного большого доклада и я думаю на предыдущих рут компах если посмотреть там и провинции был есть доклады и про шеф и про все что угодно вы это без проблем найдете вот мы остановимся на том какие инструменты предоставляет инси вот для работы с докером и все эти инструменты они идут стандартной поставке для чего дополнительно ставить не нужно просто установить эмси был у вас все это есть есть модуль который позволяет собирать контейнеры бусы собирать образы скачивать образы всего все логично следующий модуль это модуль который позволяет собственно контейнер запустить вот и недавно появилась еще два очень удобных модуля первый модуль позволяет управлять сетями это очень классно потому что пока его не было приходилось идти на определенное впечатление что построить более менее сложную инфраструктуру последние 4 модели это прям супер модуль если он появился там не знаю хотя бы полгода назад я по диплому бы точно по другому поэтому я обязательно рекомендую вам на него посмотреть это модуль который позволяет управлять инфраструктурой на основе докера через докер кампус файл и и поэтому если кто чуть подробнее знает то таким образом можно там даже в своeм все это деплоить это прям супер круто вот давайте посмотрим как выглядит запуска контейнера с помощью инси был вот-вот для контейнера которые вот таким вот унифицированным способом написано вы можете заметить что-то очень много параметров ну и давайте разберемся первый параметр собственно название приложения потому что в списке как то нам нужно и один идентифицировать то что мы запустили логично дальше у нас есть образ который мы хотим запускать вот ну и в конце концов конфигурация переменное окружение которыми мы конфигурируем наша докер-образ я думаю все знают что самый такой способ по умолчанию конфигурирования докер это переднюю докера это переменное окружение дальше это собственно куда там выписать логе что мы все слог пишем они в джейсон файле как делает доктор по умолчанию эти файлики пухнут и это плохо поэтому syslog тут нам всегда помогает опять же сеточка которую контейнер пойдет ну и в конце концов если вдруг контейнер наш упадет мы будем перезапускать логичный вопрос откуда вот эти вот три параметра взять и передать сюда в докер контейнер вот и вот эти параметры на самом деле ответ на этот вопрос я уже давал потому что раз мы конфигурируем наше приложение через переменное окружение то почему бы нам ивенте был не конфигурировать тем же самым путем это логично мы хотим чтобы у нас все было унифицирована похожи друг на друга поэтому будем точно так же конфигурировать я не забыл есть lookup моды для переменных окружения мы туда идем достаем что нужно и складывай локальные переменные и был случае с переменными окружения нужно выполнить определенные там преобразования потому что нам строку нужно развернуть словарик но тут ничего сложного нету как вы все просто понятно вот окей мы теперь имеем наши декларативные скрипты и они супер классные дам патентные но если мы запускаем руками мы не намного дальше отошли от тех времен когда к нам приходил злобный монстр за тепло что он продает продолжает приходить нам нужен кто-то кто in seoul будет запускать сначала как мы будем запускать много торопился запускать мы будем из докер а потому что раз мое приложение запускаем из докер это и intel нам логично запускать из докера тем же самым способом как мы запускаем и продакшен приложении и запуск будет выглядеть вот таким вот образом мы передаем не все необходимые нам переменные для запуска тепло и скрипта через точно также переменное окружение для начала нам нужно передать наш ключ чтоб выполнить авторизацию дальше мы можем передать ключики для амазона чтобы пойти в амазонов скайпе ой получить а и пишите тех сервировку да мы будем все это деплоить и сзади площадь и в конце концов вот эти вот три наших этой переменной которые непосредственно к приложению относятся ну и вы можете заметить что какой-то команды не указывается потому что мы уже договорились что запуском тренера без параметров это запуск для продакшна что такое запуск контейнеры deploy контейнеры для продакшна ну значит мой диплом в продакшн это у нас вот такое соглашение вот он второй член нашей команды авто тепло и пытаемся был вот но теперь возвращаемся к тому что я немного за спойлерил кто будет запускать этот процесс нам нужен тот кто сможет взять и как-то в автоматизированном режиме выполнять запуске наших и тепло и скриптов тогда когда нам это нужно и это vitlab мне интересно кто использует гид лап вообще в разработке как классно что вас так много потому что это прям супер классный инструмент и значит я думаю все что буду рассказывать сейчас прогиб лап вы так же знаете но тем не менее гид лапу это прям супер уникальная штука потому что в нем есть все что необходимо там есть это ск tracker там есть удобная система кадре view основанная на мерч и request ах если хотите вы можете включить опцию которая будет запускать у вас там встроенный чат и вам там не нужно использовать свекла вы используете встроенный чат beetle об в конце концов там есть хранилище реджис 3 и в общем все что необходимо для разработки там есть там даже есть красивые диаграммы для менеджеров вот потому что kidnap движется не только в сторону разработки но и в сторону тех людей которые допустим но им не нужно знать как писать код нам нужно просто китай метрики посмотреть все это гид лобби есть но что самое классное вы можете установить битла просто одним д пакетом через up to get это все разворачивается там внутри есть шеф скрип который поднимет настроить под grease настроит редис конфигурирует джимми чтоб он пробрасывать запросы к самому гид лабу запустят гид лап запустит реджис 3 если вам нужно и всё это в одном пакете это супер удобно весь процесс разработки собран вместе и начинает того как мы завели задачу и заканчивая тем что у нас улетела в продакшен куда там и весь процесс можно маслят следить понять что как происходило это супер классно ну а сейчас посмотрим именно ту часть beetle оба который относится к beetle обсе и которая позволяет запускать какие-то задачи это отдельный пакет называется get lapsi a multi райнер написано нога и он собственно принимает джо бы от little обсе я когда-то раньше ritlabs чай запускался отдельно по моему с 8 какой-то там версии он уже прям внутри гид лама поэтому если вы установили себе get лап значит лаптя и вас уже есть вам просто нужно поставить раннера подключить его чтоб задачки туда кидать вот и над этим раннером у вас есть полный контроль вы можете выбрать shell экзекьютора добавить пользователей из-под которого запускается runnier в группу docker и у вас есть полный контроль вы можете собирать образы запускать то что как вам нужно и это очень классно очень удобно можно сказать что это не совсем безопасно потому что ну как так мы собираем образ для одного проекта для другого они как можно в билде накосячить что-то соберется не так ну тут все просто можно каждого проекта выделять свой отдельный райнер и достигать изоляции прямо на уровне раннеров это опять же удобно по производительности потому что если у вас какой-то проект собирается довольно часто другой проект собирается редко и он 2 праге будет всегда ждать пока там очередь будет разделили ранее такой проблемы нету более того можно тегировать задачи тегировать раннеры и тем самым говорить что вот из всего pipeline а вот эту задачу будет делать ранив только с таким-то тегом то есть как-то прям у них это особенно удобно для деплоя и дальше более подробно на этом остановлюсь потому что это реально классно это дает дополнительный уровень безопасности процесса доставки кода вот и в конце концов в конфиг хранится в я малфой ли он декларативный и это очень классно потому что мы уже описываем всю нашу инфраструктуру с помощью enfeeble это уже все декларативно и собственно классно что в таком же стиле даже в таком же формате мы описываем процесс сборки вот и немаловажно что разработчик управляет процессом сборки поэтому если что-то нужно изменить если мы захотели добавить какой-то статический анализ кода или еще что-то нам нужно кому-то идти это все в нашем репозитории мы берем добавляем и получаем это сразу уже в результате в pipeline и чтобы понять будет все все изменения сразу можно увидеть вот соответственно разработчик смотрит логе смотрят какие-то метрики мы даже смотрит там к какой процент у нас успешных реплеев очень классно вот он наш третий член команды авто тепло и фотогид лапа ну и теперь давайте перейдём уже к больше конкретики к тому как в принципе устроен процесс как организовать репозитории как настроить непосредственно выкладку с использованием всех этих трех классных of the deep life наших для начала мы посмотрим структуру проекта и проект это не какой-то один репозитории то обязательно группа репозитории это очень удобно когда вы просто берете и вот делите все на какие-то не микро сервисом просто на сервис и какие то сначала мы рассмотрим те сервисы которые относятся непосредственно к приложению это логично логично что это будет front-end и back-end frontend такой-то 7 глупое предложение на java скрипте backend это и пиа и допустим там на python вот так же к этим репозитории можно отнести раньше был потому что нам важен код в который будет у нас непосредственно доставлять в продакшен все это вот и опять же если у вас появляется необходимость какое-нибудь кастомно конфигурации джеймса сделать или что-то такое это вот все сюда попадает и все эти репозитории собираются схожим образом сначала у нас происходит сборка докер образом происходит вот после того как образ собрался мы можем его протестировать запустить это статический анализ кода убедиться что он соответствует тем требованиям качества которые у нас есть если все это прошло мы можем выпустить его в релиз выпуск в релиз означает что мы образ легированный то едкой на который он собирался просто выкладываем в регистре вот в наш реджис 3 внутри гетман мы его положили этом оставили никуда запретил несла бы он не вышел пока ну и последним шагом который будет выполняться вне зависимости от того как предыдущие шаги выполнились успешно или нет это очистка всего того что осталось это прям супер важно потому что всегда есть такие проблемы что если вы используете докер он любит какие-то результаты запуском сохранять опять же вы собираете образы он от когда образ раз цитировал старый образ не удаляется поэтому за собой дурно все подчищать ночю вас будет проблема с тем что место заканчивается ну и резонно вы можете сказать что тепло это тут нет никакого как где же он находится тепло и у нас находится в в таком специальном репозитории которые называют про структурную репозитории или репозиторий энвайроменталисты сани и всей инфраструктуры целиком поэтому во первых там находится докер нам пауз файл который описывает все элементы системы как они связаны друг с другом позволяет все это дело собирается запустить раз у нас уже есть инфраструктура целиком логично здесь же оставить интеграционные тесты потому что мы уже все получили запустили теперь будем проверять как наш друг с другом взаимодействует ну и сам и сами исходники всех под проектов они подключены как под модуль поэтому нам не нужно брать и клонировать себе по отдельности там фронтэнда бэг-энда и прочее мы их экране мы клонируем себе всегда только инфраструктурный репозитории инициируем сам модуль это все выкачивается и запускай можем вот таким образом все это разрабатывать если мы не важно что мы разрабатываем front and back and мы забрали себе весь код сделали доктор кампуса по она все собралось запустилась мы работаем только с тем под модулем который нам нужен все остальное нас уже есть но опять же это заглянуть без проблем все можно сделать подправить и это очень удобно если мы делаем тестирование то тестировщик использует специальную версию доктор комп из файлов которой прописано что собирать ничего не нужно бери просто скачивай образы и запускает то есть а конфигурация есть образы скачали с реджи store запустилась мы можем проверить как оно работает в ручном режиме там подправить интеграционный тестере что то такое вот ну и в конце концов раз у нас уже тут есть интеграционные тесты и их прохождения может нам гарантировать что приложение скорее всего в продакшене будет работать мы можем использовать этот инфраструктурной репозитории непосредственно для тепло и ну и давайте посмотрим как выглядит его по apple iphone на самом деле довольно похож на тот pipeline который был до этого сначала мы собираем докер-образ которым находится интеграционные тесты потому что все в докере дальше мы запускаем интеграционные тесты которые проверяют frontend которые проверяют backend в общем все что вы считаете нужным и на этом этапе прогоняете вы это дает вам определенную гарантию что в продакшене его заработает если все оно прошло запускается тепло и скрип который скачивает у нас инте был образ который знает как деплоить и мы все плита собственно в продакшен берем и выкатываем и вот этот вот шаг диплом он запускается на раньери который не тот runnier который собирает докер образы и теста прогоняет это райнер который находится где-то близко к production инфраструктуре так как мы используем amazon то вот этот райнером прям находится внутри амазонского записи и это единственная точка входа в облака то есть наружу там с серверов приложений только там 80 порт выглядывает а больше ничего нету это супер классов для безопасности вот есть где то там какой-то непонятный сервер с непонятным о и пикником которые который никто никогда не узнают и вот он берет загружает образом раскладываются это дело мне он запускается сэнсей был в докер контейнеры выполняет диплом супер классно и удобно вы не забываем что после как процесс завершился за собой все нужно почистить чтоб место у нас не заканчивалась вот остается вопрос как и не целей и инициировать процесс диплом это можно сделать либо в ручном режиме сказал гид лабу что запусти мне pipeline для такой ветки инфраструктурного репозитории либо в автоматическом режиме по трейлеру когда у нас успешно произошла сборка допустим бэг-энда мы кидаем триггер который автоматически запускает сборку растут дурново репозитория как сделать правильно ответа нету потому что это зависит конкретно от вашего приложения того как вам удобно с этим жить кому-то классно когда все полностью автоматизировано кому-то хочется чуть больше контроля и какой-то специальный инженер запускает вот этот последний pipeline и тогда на него ложится ответственность что-то типа за диплом поэтому тут решайте как вам больше нравится вот и осталась еще одна маленькая деталь про который может быть кто то подумал кто то нет это как собственно versio не ровать релизы потому что я говорил только про ветки а про релизы там когда какая вера версия устанавливаться не говорил тут все очень просто если у вас веб-проект вам скорее всего не нужно какое-то такое супер строгой версия нирования там по 7 веру или еще покойной методологии какая разница что там три месяца назад была версия 116 8 скорее всего никогда и не запустить она просто будет где-то лежать лежать в хранилище и занимать место вполне достаточно плавающих релизом мы знаем что мастер у нас всегда выкатывается в продакшен редко develop всегда выкатывается на 100 edjing если вдруг про бак пролазит через q и через интеграционные тесты у нас весь процесс выкладки автоматизированы мы можем просто взять и выкатить ибо xix достаточно быстро вот не нужно откатывать назад диплом ся только вперед ну и там супер редких и сказать иных ситуациях когда что-то прям совсем пошло не так всегда можно найти то состояние когда она работала отсекайте цвет кисти был и вы хотите это в ручном режиме на моей памяти такое было по моему только один раз и это очень редкий случай поэтому если редкий случай можно как бы и руками поработать ничего супер страшного в этом нет собственно теперь у нас есть все все необходимые знания чтобы победить этого злобного монстра и докер пенсии был убит лап заправляется с ним и всем счастье спасибо я готов с вами пообщаться большое спасибо илья у нас на но уже в зале появились вопросы от личностью их зададим но я так понимаю что роботы победили да то есть нам уже нам людей не стоит но роботы победили используете ли вы докер он docker и если нет то почему я не использую докер в докер потому что и возможно и изначальная причина была в том что когда я начинал его использовать он был еще очень сырой и было много проблем с кэшированием с тем что мне нужно было там оттуда пробрасывать этот механизм работал не так как мне хотелось вот собственно по этой причине я не начал его использовать когда-то давно возможно сейчас ситуация изменилась вот но я не понимаю в этом особый какой-то необходимость потому что если это нужно для изоляции для какой-то дополнительного уровня безопасности но безопасность можно достигнуть за счет того чтобы у каждого проекта был свой отдельный runner это что над этим раннером полный контроль ну не такая большая проблема я так считаю спасибо отличный доклад у меня такой вопрос используете ли вы ручное тестирование и если да то в каком месте вот на всем этом папой бойни спасибо за вопрос в первоначальной версии доклада у меня были там более подробные диаграмм китом я их решил убрать видимо нужно было ставить процесс выглядит так что когда у нас необходимо допустим сзади плыть продакшен у нас есть изменения по бэг-энда мы делаем r chery квест из ветки develop a ветку мастер этот мальчик west нас появляется но потом смотреть особо не нужна но можно сделать ручное тестирование и в этот момент получается тестировщик берет запускает о себе локально всю эту инфраструктуру говорит что возьми там frontend с dagger он ее мастером возьми бык интегрированный develop am он делает ручное тестирование проверяли что все работает если все работает принимается мерч request соответственно собирается образ для бэг-энда саги ровным мастером и пайпа не допускается все это тепло лицу moody's тесно перед этим нужно изменения зарелизить чтобы у вас не было такого что то мне не сходились они что важно чтобы та же самая версия в продакшен вот потом после окончания у вас тоже сам танк яички тестеры они как-то тестами прогоняет после окончания дипой а после деплоя иногда делается ручное тестирование если там в чем то не до конца уверен вот но какого-то такого прям супер процесса что посылку на выкатилась в продакшном этом запустили определенный раунд тестирование мы так не делаем хорошо спасибо спасибо за доклад у меня вопрос а я правильно понимаю что вы их продакшене используете докер кампус мы не используем в продакшене доктор кампус вы вы как-то не не рассказали немного именно о различии сред для стаи джей для провода собственно говоря series встреч и прот не отличаются друг от друга не как есть небольшое различие именно от серверного окружения и окружения разработчик а потому что в окружении разработчик использует за докер кампус в окружении серверов там все это с помощью инси вот конфигурируются связи настраиваются и прочее то есть вот небольшое такое различие спасибо добрый день и спасибо за доклад вы сказали что вы не используете версии релизов но вот вы нашли баг например он уже на протя стало ясно то что чтобы исправить баг нужно время 23 часа может быть весь день хотя бы найти его и исправить раз у вас нет версии значит вы не можете откатиться назад и получается вы живете с богам может 1 день 2 дня жить пока его не исправят то есть как вы решаете эту проблему ну решение как бы такое не де плоти с богами вот ну кажется смешно но это не такая большая проблема потому что если у вас процесс к и построенную качественно на качественно написано тест это скорее всего баг который вылезет в продакшене это не какой-то супер сложный баг который ученица будет долго у нас баги в продакшен пролазит но они могут быть такого рода что там где-то в конфиге забыли какой-то параметр добавить или еще что то то есть это что то такое что можно решить вот прям сейчас к счастью у нас если вдруг там что-то в продакшене произойдет ну мы-то как бы это не не смерть прим то есть есть там грубо говоря там если в течение 10-30 минут похититься в принципе это приемлем вот да а и еще вопрос зайти возможно ли такое то что она ваш инфраструктура с помощью инси-блок придет мне consistent на состояние то есть он накатит частично релиз ну то есть я не знаю дата центре связь там может быть оборвалась или еще что то то есть и получается вы частично обновили его ну то есть я вижу проблему то что используя для выкладки ainsi был ну как минимум указом инвентаризационной файл кастом который мы подключаемся да нет давайте я я я понял вопрос тут помогает amazon потому что первый контейнер который запускает тепло и запускается внутри амазонского в писе то есть если она упадет то это значит видимо пойдет весь в писе целиком это серьезная проблема соответственно не может быть такое что частично на теплее лась что-то не за тепло и вот касательно того на какие сервера нужно выкатить опять же инси был идет в amazon овский пьянь узнает о и печники куда нужно положить начнем смотрит там вот есть и хасты которые процитирован у нас бэг-энда вот куда мы бы к выкатываем вот касты про тренированные front end of удава к твоим front-end и это все происходит внутри 5 то есть по сути гиьгит лапу сиай послал ласточку beetle обсе и райнеру и все а дальше это все же внутри амазона происходит и единственная причина по которой это может пройти неуспешный вот если что-то прям супер серьезно этом сводиться но то есть во вашего решения ограничения это как минимум использовать amazon то есть если амазоне используется то есть риски я правильно понимаю да ну то есть хотя бы с тем же инси план для выкладки ну опять же ну всегда можно сделать что-то подобное ну что конечно мы не сможем то получать и печники но точно также можем deploy скрип запускать рядышком с теми видно на соседнем сервере с теми серверами где у нас работает само приложение то есть проблема мне кажется ну основная проблема про который вы говорите в том что вот вот есть вот мы запустили наш тепло и он такой по сети пошел-пошел-пошел пошел на часто это деплоить оборвалось и капец но если мы запускаем прямо там рядышком на соседнем сервере но маловероятно что она сломается что все внутри дата-центра будет происходить и последний вопрос при сборке обычно что-то выкачивается из интернета хотя бы тот же но требуют модуле вы как такеши рутину то есть это явно проблема потому что а в него ну сборки java проектов 35 минут может занимать сама выкачивание файлов и сама сборка 5 минут из но да и также сколько она там медленно секунд 15 и выкачивание минут 15 то есть получается это про в данном подходе но вы когда решаете эту проблему или каждый раз при сборке надо выкачивать ресурсы по часу на самом деле в докере эта проблема решена уже на уровне каширования слоев если определенным образом писать докер файлы то как бы кэширование там работает единственная проблема что если вы там впк джейсон добавить какую-то новую зависимость до вам все придется выкачать типа и час подождать вот но после но если вы в следующей сборки ничего не меняете впк джейсоне то это просто выбраться из каши то есть там техника такая что мы даже чуть более абстрактно мы складываем в наш докер-контейнер файлик в котором содержится информация зависимостях мы запускаем тузу которую эти зависимости устанавливает после этого закидываем код приложения соответственно инвалиде ра ваться это будет только вот на том этапе когда мы файлик со списком зависимости подписываем туда если он такой же он берется из кэша следующий шаг берется из кэша то есть мы ничего не ставим и потом уже исходники закинулись и все поехал добрый день спасибо большое за доклад очень интересно используем похожие инструменты себя вы сказали что тестировщик поднимает у себя на локальной машине докер компов сделаю да как набор заппы получаю всю инфраструктуру а как быть если она довольно развесить также не только может быть фронт бэк там еще очередь какая-то разно разные разные вещи ну не не нет ну опять же что считать сильно развесистой если тут идея такая если это в принципе на компьютере можно запустить на одном там хватит производительности там сколько у нас там если в 16 гигабайт оперативки влазит то можно запустить докер компостом все поднимет возможно для более сложной инфраструктуры там будет сценарий чуть посложнее типа там докер кампус об а потом еще какие-то две три команды которые что-то да инициализировать или до запустят там может бы какую-нибудь скачает еще что-то спасибо еще маленькая процессов по поводу данных которого используется для тестирования не забираются с prada или как-то монтируется там к счастью мы можем позволить себе с prada данные забирать и делать куэй на реальных данных и если бы там база была бы настолько большая что это было бы проблематично но значит я пускал какое-нибудь решение ну и я думаю скорее всего это решение было бы такое что это разворачивалось бы не тестировщика на компьютере она каком-то специальном тестовом сервере для поднимается инфраструктура куда можно как-то синхронизировать периодически базы если на прям супер большого размера проси у меня вопрос тоже близко к предыдущему мне кажется это не было озвучено у вас моно сервис или микро сервис и вообще приложение ну это не нечто это не микро сервисы но это и не супер большой монолит потому что допустим во-первых разделен front and back in дам вот плюс на бэг-энде но опять же в разных приложениях по разному иногда бывает там что-то допустим на ноги написано потому что она потому что ей необходимо вот этой части приложения необходимо активно работать с какими-то другими сетевыми ресурсами эффективнее это сделать асинхронно поэтому на воде написано но как бы классическая и переславское но на джангар с фреймворке и в этом большое такая часть приложение ну там целая где-то сбоку подцепляется то есть это не микро сервиса который прям вот маленький маленький но несколько вот таких вот элементов которые достаточно такие крупные ki везите их всех вместе или независимо от бака на вещи имеют frontend наверное он как-то боком привязана вот именно если две-три bug1 вещи ну допустим тут нужно уже такой конкретный пример приводить вот у нас есть ли пяо и на джанки вот у нас есть целые которая делает отложенные задачи или то это собирается у нас skoda контейнера который у нас в репозитории бэкон просто разные точки входа вот значит мы тепло им наш бренд и обновляем и ту часть которую нас отвечает по и чтить и перед участие целую крутится то есть вместе получается это это да спасибо так если нас больше вопросов нет нет больше вопросов докладчик я предлагаю еще раз поблагодарить илью спасибо
