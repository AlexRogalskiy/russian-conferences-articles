**Здесь переводится видео в статью Вадима Гущенскова "Готовим Docker для Автоматизации Тестирования"**

Ссылка на видеодоклад https://www.youtube.com/watch?v=TlT_Nfys7yY

**Текст сделан из субтитров. Буду очень благодарен в форматировании текста, его вычитки. Для этого достаточно знать русский язык.
Присылайте свои pull request или присылайте текст на почту patsev.anton[собака]gmail.com**


всем привет меня зовут вадим и мы с вами сегодня поговорим о покере [аплодисменты] спасибо я узнавал сегодня это не единственная единственная презентация о блокера у нас целый такое покер междусобойчик есть так что не первый не последний раз когда вы это услышите что говорит о том что то у актуальны немного о себе я нет автомашин инженер в компании epam systems и я работаем войти уже даже более семи лет и все это время я тестов на мишин инженер и основной фокус моей работы это автоматизация веб-сервисов но не только их я также имею большой опыт baby автоматизация а также автоматизации клиент-серверных приложений вот и недавно относительно недавно в моей работы начался такой мейнстрима войти и когда приложение под строятся по принципу микро сервисов и наша не исключение немножко проекте до наше приложение как я уже сказал это микро сервисы наш заказчик технологически очень подкован старается использовать все последние достижения войти на моей памяти не было никаких проблем с внедрением чего-то нового скорее были проблемы наоборот мы гуляли всю новое и отчего-то потом отказывались так как это икра сервисы они очень сильно завязаны друг на друга один сервис часто вызывает по цепочке несколько других и это тоже накладывает свои свой отпечаток я потом расскажу какой и у нас уже латную используется докер у нас нет сервисов не брокер контейнерах мы все дупло им в докере куда бы то ни было покоем и диплом ну вот такая у нас ситуация сперва из говорилось во всех конференциях значит надо повторить еще разок преимущество докер докером 1 это нетребовательность к окружением по большому счету нам но какой провайдер мы используем главное чтобы там стоял брокер и тогда мы можем туда за диктуется windows linux без разницы есть некоторые баги которые не позволяют нам использовать допустим что под windows на несущественные там больше работа с ю а м у нас же сервисы мы можем себе позволить загибается просто-напросто на windows следующая это относительная легкость установки относительно я почему потому что докер можно докер можно собрать все ваши зависимости допустим у нас для некоторых сервисов у нас используется аж до 3 уровня ки каширования это engine x-men кэш и еще родис все их мы можем запаковать в докер контейнеров настроить и выкатить одним-единственным артефактом и настройка уже это ложится не на да вепсов с той стороны со стороны провайдера она на нас девелоперов на тостеров и это кстати дает некоторые неочевидная benefit к том числе пример из практики наш один из наших клиентов точнее из окружений не использовала ни в какую докер то есть он говорит не допер не нужен делайте что хотите хорошо мы ему передали все наши артефакты все наши сервисы либо 5 летом 9 страничный мануал как это все настроить в том числе там было недострой как сша они да они начали ставить им это даже удалось но в какой-то момент нам сборе то их говорят извините у вас там проблема stick юностью мы вы позвали сессию пользователя она как бы не то звалась и да они просто напросто мануал по установке был просто полотнищем их бы вы пса не дочитали до конца и пропустили пропустили шаги по очистке крыш и по настройке очистки кэша как итог сосед отзывалась но никто об этом не знал юзера дальше продолжали пользоваться им до тех пор покуда лишь не умрет а умирал он достаточно долго вот таким образом докер-образ это наш полноценный артефакт действительно полноценные артефакты которую мы можем передать кому угодно и избавиться от ряда проблем в настройки установки ну и так далее что какие вызовы поставил передо мной этот проект перво-наперво когда я пришел это все уже было это были настроены процессы на отсутствую помощь полностью тестирование и я подумал каким образом проект где куча микро сервисов все в докер их можно строить тестирование понятно можно использовать метод по старинке поднять окружении одно окружения туда натыкать наших сервисов их настроить построить базу настроить с шину настраивать много чего еще и уже сбил сервера а триггеру запускать наши микросферы наши тесты для наших сервисов и тестировать микро сервисы один за другим ведь они все переплетаются но да у этого окружения по старинке есть недостатки первое если ваши сервисы используют работают асинхронно используют как я уже говорил message бас используют кластерные база данных то есть у вас есть рипли клей шон лок на информацию в этом случае вам приходится вставлять дополнительные дополнительные ожидания на ваших постах дополнительные assertion и исходя из текущей ситуации а еще прибавьте к этому если несколько команд работают одновременно одном от окружении когда у вас получается ситуация что вы не доверяете своему окружению кто-то за тепло и какой-то непонятный непонятную версию артефакты которые допустим содержит новые баги и вас тесты падать причем тесты которая медик так не должны уже там сто раз было сто раз проходили и тут упали поэтому идеальная ситуация это когда у каждой команды свое окружение но понятным причинам такое сделать невозможно во первых это очень накладно даже если мы выделяем на каждые каждое окружении на каждый микро сервис по мелкой выемки если у вас 20 команд это 20 окружений плюс пароль почему это невозможно ваши сервисы вы должны сами настраивать идите к настройке сервис 20 окружении невозможно не работает постоянно кто-то пишет что что-то не достроена что-то куда-то не конектится что-то где-то падает поэтому следующий вопрос можем ли мы как-то улучшить тестирования вот это вот окружения с помощью докера и домножим далее как запускать наши сервисы используя одну и ту же версию это еще один вызов понятное дело что есть nexus не которые кладутся все наши зависимости туда попадает веб-сервис и тесты запустить тест из нексуса скажем спустя пол года разработки вас . получалось скорее всего нет потому что зависимости они обновляются появляются новые баги обновляется программное обеспечение на сервере появляясь появляются новые новые проблемы и последний челленж которыми которые нам ведь нами предстал это как мониторить наш продакшен к сожалению у нас не все сервисы это строительных лес rest большинство сервисов они да такие но есть один который стоит full это конкретно это часть сервис базирующиеся на технологии xmpp на стандарте xmpp и у него были очень очень специфичные проблемы когда он был за диплом в кластере из-за network проблем у провайдера в определенных случаях он потерял синхронизацию и не мог их восстановить и восстановить и получилось так что юзер заходят на в чат с одной ноты со второй но да у него все хорошо а вот эти моды каких-то случаях он не заходят и на мониторинге все отлично то есть все новые работают идеально но просто с одной из них юзер не может попасть ключ от комнаты его сразу же выбрасывать изза россен хронизации и так какую стратегию я придумал 1 первую очередь это отказаться с большего отказаться от окружений все тесты у нас основные функциональные тесты у нас будут запускаться изолированы изолированную в отдельном докер контейнере это наш первый будет слой основной тестированием следующий слой это как мы его назвали deployment графики чем тест просто верификации дипломантов фактически когда у нас есть по-любому нас есть ps3 моменты но мы всего лишь их с мукой и все отличия смог теста от диплом and verification теста только в том что диплом and verification теста радуется относительно каждый мода в окружении каждый модуль за элби то есть надо выводится из ротации тестируется вставляется обратно и для тестирования для мониторинга уже продакшена мы разработали так называемые кинари тесты почему канареек генри это такой термин когда шахтеры они клетки спускали канарейку шахта если когда они подумают о канарейка она там живо значит а можно в шахту спускаться если мертва нельзя поэтому же аналогии и тесты да прежде чем идти по слоям какие подготовки требовались для того чтобы сделать вывести это всем life первое мы все тесты наши просто пакуем вот за киту был uber jar который размещается прямо в докер образе с веб-сервиса мы как бы думали что может быть держать его отдельно может быть нет но на самом деле это просто jar к она просто немножко добавлять вес и вашим артефактом и ничего не требует взамен зато потом вы получаете на ценный образ и рядышком с вашими с вашим продуктом тесты артефакт также добавляются с помощью директивы м3 поинт добавляется shop-script entry point is each который понимает команды старт который стартует web service test которая тестирует веб-сервис как итог у нас получается ума ценный уже testing артефакт который мем можем отправить в наш собственный докер registry до для этого надо иметь свой дом докер лидерский уже докер реджис 3 уже является как бы источником вашего ваших артефактов продакшене источников всех ваших стабильных версий они уже не nexus lexus получается как вторичен в этом плане изолированное тестирование первый наш слою самое основное самый хитрый вот как я говорил тесто очень сильно взаимосвязаны между собой и не всегда получается что-то там замок от потому что когда их там три штуки это уже сильно бьет по времени один можно при сложном поэтому мы используем докеры и докер индюки для построения полноценного окружения в докере в самом дочери у нас есть образ со всеми зависимостями база данных рассказал редис вас грейс келли пеший г-н дженкс а также missing you мы используем рабби робот intel мы все это пакуем при помощи тех же докер бунт файлов в один контейнер подкладываем туда наши веб-сервисы если нам надо 2 при веб-сервиса мы туда закидываем их если у нас есть мойки мы подкладываем туда маки и получаем полноценные артефакты которые изнутри тестируется командой просто гряда тест просто уже он подымается уже набил нодди сразу после сборки сборки нашего первого артефакта основного веб-сервиса и тесты уже днем запускается соответственно вывод просто производится в стандарт out и определяется секс с или файл определяется просто response кодом галя до такой контейнер он тоже артефакты им тоже можно делиться его и можно отдать другим командам вот пожалуйста наш все наши сервисы вот вам порты на которую стучитесь они будут работать вы просто запустить запустить и их докер ранам и все можете вы можете интегрироваться тестировать все что угодно это что касается изолированного тестирования но вопрос стоит дальше как нам тестировать наш диплом начнем с нашего для племен процессом он в принципе достаточно простой это роулинг роулинг обед то есть есть свой баланс в котором мы допустим 40 1 надо помечается неактивной деактивируется изабелла мастера и на нее больше не идут ни какие запросы дальше не ест с помощью докер ps очищается все докер контейнеры которые они запущены копируются из нашего докер из 3 новые включая как у нас один артефакт с тестами включая и тесты запускается тестированием если response код ноль все окей но до возвращается в ротацию таким образом у нас максимум а точнее минимум при наби рабочие во время стала и это что называется земля сын стал то есть мы инсталлируем ся без down time a production более подробно работает диплом and verification теста после запуска основного контейнера на дисплее у нас есть небольшая фаза называется проб смысла я в чем-то там просто кулем рулем сходятся на чек до тех пор пока оно пока hacer не вернет 200к только холстед вернул 200 мы знаем что наш сервис поднят мы не знаем работает ли он потому что опять таки зависимость в зависимостях может закрасться ошибка мы передаем наших конфигурацию параметров н то есть минус минус n докер ран и здесь тоже может быть ошибка особенно когда мы новый параметр вводим соответственно надо узнать а можно ли такую моду вводить в ротацию и мы параллельно не не в самом друг докер контейнеры а параллельно ему запускаем еще один дотер better ран и уже при помощи команды нет контейнер не их jonim в одну и ту же сетку и запускаем тест и против лаковых остров это дает нам несколько преимуществ мы знаем как что порты на оригинальном контейнере прокинут и как надо потому что они появляются тогда в окнах раз тем и соответственно когда мы начинаем тестировать все зависимости уже подняты мы можем на них ссылаться как на обычные сервисы и когда мы оттестировали мы понимаем что вся конфигурация она да платная уже можно выкладывать этот артефакт этот контейнер эту ногу обратно в lb соответственно докер-контейнер докер-образ который отработал и вернул но лет он просто скатывается информация о нем удаляется и всё у нас готово к работе ну да без каких-либо побочных оставшихся от тестов настроек или там я не знаю репортов или еще чего то чтобы дополнительно чтобы застраховаться от того чтобы тесты каким-то образом не обвалили наш энвайроменталисты заводь ряд флагов у докера у команды докер ран и the memory имеется плюша рис мы можем просто ограничить количество тактов цифру и количество используемой памяти таким образом это достаточно безопасно ну и последний наш слой тестирование вот которые который предназначен для мониторинга продакшена вот этот канал testing как я говорил у нас есть faithful сервис который к сожалению после 30 где-то 40 дней в продакшене он может деградировать поэтому мы постоянно запускаем наше тестер на продакшен они крутятся там 24 на 7 мы можем всегда зайти на любую продавшим но так как у нас полноценный артефакт с тестами и запустить тестируем так же мы можем делать это все через бен сервер за запуская тесты набил сервер си просто один за другим сервере один за другим и смерти в случае если они упали более того мы можем еще считается и при помощи таких как google cloud platform и amazon web services мы можем нанять ноды в разных time зонах и тестировать них наши сервисы это будет не просто простой пинка будет уже полностью работоспособность проверяться наших сервисов таким образом можно создать вот такой вот виджет специальный виджет для граф она называется был 2 и статус и наши но до приблизительно и их расположение и доступ к нашим сервисом вот как вы видите у нас большой priority to the east crude свойств кости европа оттуда мы больше всего мониторим наши сервисы и вот видно там не джерси да ведь вируса долларов что-то надо смотреть наши сервисы очень высоконагруженные нам приходится так загоняться поскольку никому не интересно работает ли ваши сервисы из-за точнее не работают ли ваши сервисы из-за проблемы провайдера или то у вас с проблемы все и всегда хотят использовать в 24 на 7 и данная технология данный подход позволяет нам быть уверенным в том что мы можем построить наш наш правда так чтобы это было 24 на 7 и наверное все я рассказал быстрее чем я думал поэтому я открыт для ваших вопросов есть а скажите пожалуйста что для лакирования используют что там говорила что код ответа там но там 200 либо не блюбук это неправильно да если вот он неправильно то как как вы анализируете то есть на основании чего что используется для анализа данных но веб всех тестов о новых выводится в стандарт out то есть когда набил сервере мы открываем наш блог там все видно то есть видно тесты и что вот там конце столько такое улучшится в такие the stack trace и если кот кот не 0 response код не ноль то у нас появится бинт все останавливается при остальные ноды они остаются как бы рабочие еще вопросы [музыка] всем спасибо [музыка] [аплодисменты]
