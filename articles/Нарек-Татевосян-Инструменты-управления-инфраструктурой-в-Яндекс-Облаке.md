**Инструменты управления инфраструктурой̆ в Яндекс.Облаке**

![](https://habrastorage.org/webt/g7/ze/9t/g7ze9tzdtzfys3j7osineawsjnu.jpeg)

Здравствуйте, коллеги! Сегодня я расскажу вам об инструментах управления инфраструктурой в Яндекс.Облаке. Меня зовут Нарек Татевосян. Я являюсь одним из архитекторов Яндекс.Облака.

![](https://habrastorage.org/webt/xk/nh/-0/xknh-0btsypzqrjukx7nkaom4ma.jpeg)

Для начала посмотрим на результаты опроса, который вы прошли, когда регистрировались на наш вебинар. Опрос был достаточно понятный и простой: «Какие инструменты вы используете, работая с Яндекс.Облаком?». 

Большая часть пользователей использует Web console. Чуть меньше людей используют CLI. Еще меньше людей пользуются Terraform, REST API и SDK. Поэтому сейчас расскажем детально об этих инструментах.

![](https://habrastorage.org/webt/s2/wz/qy/s2wzqy1za2rt8etfuhmryy0qlko.jpeg)

О чем мы поговорим в данном вебинаре? 

В первую очередь пройдемся по самому понятному и простому – это Web console. Мы еще раз напомним о ней, хотя все, наверное, о ней знают. 

Дальше пройдемся по инструментам автоматизации таких, как CLI, Terraform, REST API и SDK.

И далее по результату прохода по всем инструментам я сделаю некое сравнение, когда и какой инструмент необходим. И расскажу, какие у нас есть планы по развитию инструментов. И расскажу, что можно использовать и в каких ситуациях, а что не стоит использовать.

![](https://habrastorage.org/webt/r6/2h/qa/r62hqaw5cq7gew3bsc0bkoltkqe.jpeg)

Вебинар состоит из 5 блоков, каждый из которых примерно по 10 минут. 

В каждом блоке я буду делать несколько слайдов по каждому инструменту. И далее буду демонстрировать, как эти инструменты можно использовать. Все, что я буду показывать в вебинаре в виде демонстрации, это доступно в репозитории на GitHub по ссылочке: https://github.com/nar3k/yc-automation. И можно в свободное время воспользоваться этой ссылочкой и проделать все эти операции, а в дальнейшем применять в своей работе. 

Сценарий будет простой и понятный, т. е. мы будем создавать виртуальные машинные сети. На виртуальной машине мы установим какой-то софт, в данном случае это будет nginx. И далее добавим всю эту историю в балансировщик нагрузки.

### Web-консоль

Начнем с самого понятного, с Web-консоли.

![](https://habrastorage.org/webt/0s/qd/ao/0sqdaouuf5t9ghfzrd01k4qmvlu.jpeg)

Web-консоль – это дефолтный интерфейс работы с Яндекс.Облаком. Он доступен из любого браузера. Также Web-консолью можно воспользоваться не только с рабочей станции, но и с мобильного телефона, что иногда в жизни помогает.

Понятно, что он самый простой. В нем много функциональности. Есть у нас функциональность, которая сначала бывает доступна только в Web-консоли. Например, когда у нас выходят alpha-сервисы, то очень часто они могут выходить только с Web-консолью и REST API. Поэтому, если вы хотите ручное управление, то, наверное, на первых этапах будет доступна только она. 

И через Web-консоль можно сейчас заказывать доступы к alpha-сервисам наших продуктов. Вы можете перейти в консоль, нажать на нужный вам сервис. И если у вас нет доступа, то появится формочка запроса, и вы можете заказать доступ. И через какое-то время он у вас откроется. И вы сможете одним из первых попробовать сервисы Яндекс.Облака. 

![](https://habrastorage.org/webt/3h/lv/ef/3hlvefuxdivhtkf3nyeo-zxedyq.jpeg)

Я проведу первую обзорную демонстрацию. Естественно, виртуальную машину мы создавать не будем. Покажу текущую web-консоль.

Она у нас состоит из сервисов, названий облаков. В Яндекс.Облаке можно переключаться по вашим облакам. Аккаунт может находится в разном числе облаков, вы можете переключаться между ними и работать между ними. 

Все задачи я буду выполнять в каком-то определенном folder. Если вы хотите провести какие-то эксперименты, делать какие-то sandboxes для своих задач, то очень рекомендую под это делать отдельный каталог – folder и в нем уже делать задачи.

Сейчас у нас folder пустой. И постепенно по ходу демонстрации у нас этот folder будет наполняться различными сервисами, а потом удаляться. Это первая часть демонстрации.

Вторая часть демонстрации, которую хочу показать, это репозиторий GIT, в котором представлена демонстрация, т. е. в этом репозитории указаны все инструменты для начала работы, чтобы самому провести все демонстрации, которые я сделал. И по каждой демонстрации описаны этапы, что надо сделать.

Здесь у нас написано, что надо вводить руками, что надо править руками. И есть скрипты, которые все это автоматизируют, чтобы это можно тоже применять. Здесь все в основном написано на Bash и Terraform, но ничего не мешает делать это на своих удобных вам языках. 

**Отвечаю на ваши вопросы**

*Когда будет можно менять имена облаков?*

Сейчас имена облаков менять нельзя по той простой причине, что имя облака – это уникальный ID. Мы от наших пользователей таких запросов не получили. Если для вас это важно, напишите в поддержку, мы агрегируем фичреквест. И если получим достаточное число пользователей, для кого это важно, тогда мы перейдем на реализацию. 

*Terraform только для VPC сейчас?*

Сейчас в нем можно создать виртуальные машинные сети, постепенно будем функционал расширять. Как перейду к разделу Terraform, расскажу в каком виде он находится и как будем его развивать. 

### CLI

Что такое CLI?

![](https://habrastorage.org/webt/ax/su/0z/axsu0zmrwvatxblwhucojzwzijm.jpeg)

Это инструмент управления ресурсами Яндекс.Облака через командную строку.

Он позволяет делать очень-очень много операций с облаком в удобном виде для тех, кто хочет сделать чуть-чуть быстрее, чем через web-консоль, либо хочет какую-то повторяю инфраструктуру, т. е. скриптовать какие-то действия, либо хочет делиться скриптами с коллегами, чтобы они могли делать какие-то операции.

Очень часто на практике, общаясь с клиентами, даем им какие-то командочки, которые они могут использовать через наш CLI, применяя это в работе. 

Ставится он очень легко. Есть ссылочка на наши документации. Вы ее вставляете и выполняете команду в `yc init`, выбираете нужное вам облако, нужную вам папку и переключаетесь, и работаете. 

![](https://habrastorage.org/webt/lk/qt/qm/lkqtqmyygvldgian3vzxcq45p8g.jpeg)

Вторая часть, которая часто используется нашими клиентами, в том числе для того в работе через командную строку, это bootstrap виртуальных машин, т. е. какая-то настройка первичного софта на виртуальной машине, которая позволит с ней далее работать.

И самое быстро и понятное, что доступно из коробки в нашем облаке – это сервис метаданных. Это сервис, который при первом старте виртуальной машины может выполнить определенный конфиг на этой машине, который вы зададите при ее старте. 

Это сделано следующим образом. У нас на виртуальных машинах в наших образах установлен demon cloudinit, который при установке установит сначала ssh-ключи и далее установит пакеты, пользователей, т. е. все, что можно установить через пакет cloudinit.

Из понятного и быстрого – это установить определенный набор пользователей, установить веб-сервер, как я буду делать. И далее установить, например, агента для chef или puppet.

И к метаданным всегда можно получить доступ, выполнив с локальной машины запрос. Веб-сервер доступен по адресу 169.254.169.254. Очень важно понимать, что к этой информации может получить доступ и виртуальная машина. Если вы вдруг используете контейнеры, то очень часто контейнеры имеют доступы к этому IP-адресу, поэтому не рекомендую хранить там секреты. Нужно понимать, что с вашей машины всегда можно получить доступ к этому сервису и это могут использовать злоумышленники.

![](https://habrastorage.org/webt/oj/ha/zq/ojhazqjrmizhq1_1lwpzwslj3rm.jpeg)

Проведем первую демонстрацию. Она будет состоять из создания сети ряда виртуальных машин с веб-сервером nginx.

Мы находимся в нашей демке. Я буду делать все, как описано в демонстрации. Буду запускать скрипты и показывать.

Первая часть демонстрации состоит из команд строки, которые создадут сеть, создадут в этой сети три подсети с тремя разными диапазонами и создадут три виртуальные машины. 

У меня это сделано с помощью скрипта create_infra. Я, чтобы сэкономить ваше время, поставлю его запускаться. И далее расскажу. 

Первая команда создает сеть. Потом я в цикле создаю подсеть с каким-то именем, с каким-то диапазоном, который зависит уже от названия сети. И далее создаю виртуальные машины. 

Виртуальные машины у нас используют вот этот файл metadata-from-file, который ссылается на локальный файл, который называется metadata.yaml. Давайте его посмотрим. В нем я сделаю несколько простых вещей. 

Я обновляю наш репозиторий. Создаю пользователя. В этого пользователя добавляю публичный ключ для доступа. Устанавливаю nginx. Ставлю его. И в дефолтную веб-страничку пристыковываю hostname.

И давайте посмотрим, как это выглядит с точки зрения Web-консоли. Я сейчас ее перезапущу. У нас создалась сеть, создались подсети, создались виртуальные машины. Можно посмотреть на последовательный порт через Web-консоль. Можно на последовательный порт виртуальной машины посмотреть через командную строку, которая вам покажет, что было сделано. Тот же самый статус виртуальных машин можно посмотреть через саму консоль. Здесь мы видим имена виртуальных машин. 

Также консоль позволяет выводить результат в формате JSON. Например, мы хотим получить IP-адрес созданной нами виртуальной машины. Мы пока все не успели в консоли реализовать, поэтому я выполню вот такую команду, которая сделает следующее. Сначала я покажу, как можно JSON вывести. Всю информацию обо всех виртуальных машинах мы можем получить в формате JSON, выполнив эту команду. И далее с помощью jq удобно парсить и фильтровать по ней. 

И если я хочу получить все внешние IP-адреса, я выполняю со следующим ключом, получаю все IP’шники. И далее это можно автоматизировать. Я сейчас получил IP-адреса всех виртуальных машин, которые я создал. И сделал в этот IP-адрес curl. И так как я в файле метаданных записал hostname каждой виртуальной машины, то nginx должен мне отдать hostname виртуальной машины. И, соответственно, все три виртуальные машины создались. Все успешно. 

Если требуется, то можно сделать ssh-соединение к виртуальной машине. Если мы загрузили правильный ключ, мы получаем в него сразу доступ. 

Здесь мы можем фактически несколькими движениями императивно создать структуру. 

Сейчас мы ее удалим и будем двигаться дальше. Удалять мы будем через yc. Соответственно, проходимся по всем instances. Сначала удаляем их, потом удаляем подсети, потом удаляем сеть.  

**Отвечаю на ваши вопросы**

*Будет ли увеличен лимит на количество команд CLI, выполняемых одновременно?*

Это хороший вопрос. У нас есть лимит не на количество команд CLI, которые выполняются одновременно, а есть лимит на количество запросов в наш API, которые выполняются одновременно. 

Если вам требуется увеличить лимит, то напишите в саппорт. Это как квота количества IP-адресов и т. д. сейчас у нас реализована, поэтому можно написать в саппорт, и вам должны увеличить квоту.

*Будет ли клиент или SDK под андроид?*

Хороший вопрос. В планах такого у нас, но, если вам требуется какая-то мобильная разработка, можно использовать REST API, который можно использовать под java. С SDK у нас пока в планах нет. У нас какая-то разработка ведется внутри. Я уточню у коллег. На текущий момент планов под java нет, но есть REST API, который можно использовать под эти задачи. Про него покажу и расскажу. 

### Terraform

Что такое Terraform, зачем он нужен и как он интегрируется с Яндекс.Облаком?

![](https://habrastorage.org/webt/pn/ps/zk/pnpszkpddrxzxwrpjc4uzd_jetm.jpeg)

Terraform – это open source утилита от HashiCorp, которая позволяет декларативно управлять инфраструктурой по модели Infrastructure as a code.

Что это значит? Это значит, что вы можете в Terraform в виде конфигурационных файлов описать ваше целевое состояние инфраструктуры и далее сказать: «Terraform, примени». Terraform посмотрит на ваше текущее состояние инфраструктуры, посмотрит на целевое состояние и перейдет из текущего в целевое. 

Terraform очень гибкий и имеет коннекторы к большому количеству систем: не только к нашему облаку. Мы недавно сертифицировались. Сейчас находимся в репозитории официальных провайдеров Terraform. Есть еще коннекторы к большому количеству других облаков, других систем, систем виртуализации и т. д. 

В этом плане он достаточно гибок, понятен и очень сильно популярен, поэтому мы внутри себя его часто используем. И постепенно будем его развивать для большинства своих внутренних задач, и постепенно будем его расширять в плане его возможностей.

![](https://habrastorage.org/webt/vp/ac/dr/vpacdru07rr0i4qm69q66q7ft_a.jpeg)

Что такое декларативное состояние я об этом рассказал, теперь покажу на картинке. 

Справа здесь представлен граф, который описывает тот набор действий, которые Terraform должен выполнить, чтобы создать виртуальную машину, сеть и подсети. Здесь мы в каком-то наборе файлов указываем, что мы хотим создать сеть, виртуалки, подсети, виртуалки поместить в подсети, а подсети использовать для сетей. 

Terraform постепенно вычисляет. Тут это можно увидеть. У нас есть instance. У нас есть еще outputs, что должен Terraform дать в результате. Но все сводится к тому, что надо создать виртуальную машину. 

Виртуальная машина должна сослаться на какую-то подсеть. А подсеть на сеть. И Terraform, создав такой граф, в обратном порядке выполняя все эти действия, приходит к целевому состоянию.

Это очень удобно, очень понятно. Работает достаточно стабильно. И Terraform еще удобен тем, что, например, вы можете инфраструктуру переиспользовать. Т. е. вы можете тестовые стенды делать и с разными переменными окружений их переприменять. Например, вам надо с коллегами поделиться профитом, концептом, то всегда очень удобно использовать для этого Terraform.

И в том числе удобно управлять своей инфраструктурой по модели GitOps, когда вы все держите в Git’е, применяете там все ваши изменения в нем, и дальше он все деплоит. И вы достаточно прозрачно видите то, как устроена ваша инфраструктура. 

![](https://habrastorage.org/webt/es/7b/-s/es7b-stgbvificjmlvaefqfzaro.jpeg)

Модель инфраструктура как код имеет очень хорошее свойство. Здесь вы можете достаточно гибко работать с большим количеством облаков, провайдеров и т. д.

Не стоит ожидать, что Terraform за вас будет делать мапинг сущностей Terraform типа виртуальная машина в разные облака. Нет, вы просто должны быть знакомы с каждым облаком, либо контейнером, либо провайдером Kybernetes. Terraform просто говорит: «Сделай мне вот это, создай мне в Kybernetes deployment». И вы должны четко ему описать, что такое deployment, т. е. из каких кубиков он состоит. Либо сказать: «Создай мне в Яндекс.Облаке сети, подсети» и достаточно строго дать ему те ключи, которые понимает именно Яндекс.Облако. 

Terraform – это просто инфраструктура как код. Вы должны сначала понять, как выглядит провайдер, с которым вы работаете, а потом вы это можете переложить в Terraform.

Из практики я обычно делаю что-то в CLI, если мне надо быстро понять, что и как, а потом все те же ключи из CLI переношу в Terraform. И дальше это переиспользуем. Это очень удобно. И такой подход достаточно универсальный, потому что Terraform, CLI и даже REST API ссылаются на одну точку входа в нашем облаке. И поэтому модель инфраструктуры в нашем облаке одинакова, поэтому одну и ту же задачу можно выполнить разными инструментами, но ключи, которые вы вводите в эти разные инструменты, они порой не отличаются. Они могут отличаться удобством восприятия, но в итоге все приходит в одну центральную точку входа. Это gRPC API.

И также надо понимать, что у Terraform есть такая сущность, которая называется бэкенд. Terraform хранит текущее состояние инфраструктуры в виде какого-то файлика, например. Его локально хранить не очень удобно, если вы хотите использовать его для какой-то командной работы. Потому что одной инфраструктурой не только вы у себя на работе можете управлять, у вас может быть целая команда. Для этого в Terraform есть такая сущность, которая называется бэкенд, т. е. это то, куда можно складывать текущее состояние вашей инфраструктуры.

И в качестве бэкенда у Terraform есть S3 backend. И в нашем облаке есть сервис, который называется Yandex Object Storage, который можно использовать под эту задачу. У нас команды, которые используют для своих сервисов Terraform, весь state хранят в Object Storage.

![](https://habrastorage.org/webt/a8/tt/9v/a8tt9vwq5avhcfiiop117esc2jo.jpeg)

Перед тем, как перейдем к демонстрации, скажу важный момент. Terraform может казаться сложным, но он очень прост в освоении. Если вы откроете Getting Started, то здесь будет полуторачасовой курс по Terraform. И после этого вы сможете его использовать на практике. Вы сможете все, что вы узнали на этом курсе, сразу использовать и в нашем облаке, и в любых других облаках, которые вы используете. Очень рекомендую пройти этот курс. 

Terraform состоит из своих сущностей, которые ему только присущи, поэтому если вы сейчас с ним не знакомы, и я вам сейчас покажу демонстрацию, то вы, скорее всего, не поймете, как он эту магию делает. Но эта магия состоит из понятных кубиков. Поэтому я вам очень советую этот курс пройти, потому что это вам в вашей жизни облегчит многие задачи. 

Перейдем непосредственно к демонстрации. Мы будем делать ее медленнее. Она называется Terraform. Из чего она состоит? Она состоит из того, что у нас есть папка. Мы сейчас в нее перейдем. В этой папке, если посмотрим ее структуру, есть определенный набор файлов формата tf.

Формат tf – это формат, который написан на языке HCL. Переводится это как HashiCorp language. HashiCorp – это компания, которая является создателем Terraform, которая продает enterprise-версию этого продукта. 

Пугаться того, что придется освоить новый язык, не стоит, потому что язык HCL очень понятный и простой в освоении. И если вы работаете с YML, то вы удивитесь, насколько HCL удобнее, чем YML. И он удобнее не только в разработке, но и удобнее в чтении кода. Например, вам дали набор файликов. Если вы два-три раза с Terraform работали, то вы достаточно быстро поймете, что это из себя представляет, поэтому не стоит этого пугаться. Стоит это быстренько освоить и использовать в своей жизни. 

Что я здесь создаю? У меня есть описание сети. Я просто говорю «resource». И, соответственно, у него есть имя. Есть второй ресурс, который называется подсети. Я с помощью директивы count создаю три подсети. И есть ресурс, который называется main.tf. Я в нем создаю виртуальные машины. 

Сначала я цепляюсь и использую провайдер Яндекс. Использую там креденшелы. Если откроете описание репозитория, то увидите, в какой файлик их надо сохранить, чтобы это работало.

И есть ресурс, который называется yandex_compute_instance, который я node назвал. И в нем практически все те же ключи, которые вы использовали в CLI, можете их сюда перенести. 

Вам на текущий момент достаточно просто поставить Terraform, наш провайдер туда уже встроен. И здесь вам, когда вы это все выполните, нужно сделать Terraform init. Всегда его нужно выполнять, потому что Terraform init – это операция, которая скачивает все зависимости. И дальше выполнить Terraform apply.

Terraform apply как раз вычисляет граф-зависимости и создает какой-то набор ресурсов, который нам нужно создать. Он у нас создает nodes. Это виртуальные машины, я их так обозвал. Вот он у нас создает nodes, создает сети, создает подсети. Всего 7 ресурсов, т. е. у нас одна сеть, в ней три подсети и в каждой подсети по виртуальной машине. 

Здесь мы соглашаемся. И дальше он сначала создает сети. Вот он создал сеть, потом подсети, а потом, как только он создал подсети, он уже создает виртуальные машины. 

Давайте посмотрим, что у нас получилось. Названия у нас те же. Виртуальные машины тут стартуют постепенно. Постепенно у нас в последовательный порт сейчас начнет сыпаться информация о том, что у нас установился nginx. Мы уже видим, что при создании виртуальных машин, им сразу внешние IP присваиваются. Мы можем вот такие внешние outputs с помощью команды Terraform output использовать. И далее это использовать в дальнейшем программировании. 

Сделаем скрипт, который проверит, что виртуальные машины установились. Что это за скрипт? Скрипт вытаскивает IP-адреса, которые мы получили при Terraform, и делает в них curl. Мы этот скрипт создали, сделали. И мы понимаем, что виртуальные машины создались.

**Отвечаю на ваши вопросы**

*Планируется ли обновлять Terraform, добавлять возможности?*

Да, планируется. Мы идем по этому пути. Следите за новостями, ожидайте, что постепенно у нас будут появляться новые возможности в самом Terraform. И очень надеемся, что мы придем к модели развитых облачных вендоров, которые при выпуске какого-то сервиса, сразу дают коннектор к Terraform: сразу или в течение следующей недели. Думаю, мы к этому придем. 

*Можно ли создавать прерываемый VM с помощью Terraform?*

Скорее всего, нет, потому что прерываемые VM у нас вышли буквально неделю или две тому назад, пока в Terraform это не появилось. Но в CLI это должно появиться. И прерываемые VM должны быть еще доступны в instance-группах. Если у вас есть задача как-то это переиспользовать, то проверьте, возможно, если не в Terraform, то в instance-группах вы это можете уже использовать.

*Планируется ли Security Group (это распределенный firewall, который можно виртуальной машиной использовать) и таблица маршрутизация, которая позволяет управлять маршрутизацией в облаке?*

Таблицы маршрутизации у нас уже работают. Они находятся в стадии в preview у определенных клиентов. Напишете в саппорт и попросите, чтобы их активизировали. Скажите, что на вебинаре вам сказали, что это можно сделать, и мы вам их активизируем. Через какое-то время они появятся в public и будут доступны уже у всех. 

По поводу Security Group – да, это у нас появится, следите за новостями. В этом году это у нас будет.

*Если создать виртуальную машину без внешнего IP, то она не имеет доступ к репам, так ли задумано?*

Да, задумано так. Сейчас это действительно работает так, чтобы виртуальная машина могла иметь доступ в интернет. Чтобы скачивать какие-то репозитории, у нее должен быть внешний IP-адрес. Но в прошлом вопросе нас спрашивали про таблицы маршрутизации. И когда у нас появятся таблицы маршрутизации уже в public, мы в том числе опубликуем два сценария, в которых будет описан сценарий, как с помощью таблицы маршрутизации и NAT instance можно будет сделать так, что вы создадите одну виртуальную машину с внешним IP-адресом, настроите статическую маршрутизацию в облаке. И все остальные машины в сети можно будет создавать без внешних IP-адресов, но они будут иметь доступ в интернет. И это так работает у большинства игроков, но у всех есть разные реализации этой истории. Мы двигаемся постепенно-постепенно.

Доступен ли сейчас NAT instance? Мы его, наверное, успеем в Market Place опубликовать вместе с выходом … . Но в любом случае будет статья, в которой будет написано, как его настроить. Это виртуальная машина с Linux, в которой надо три-четыре команды ввести, чтобы это все активизировать. И все будет работать. 

Чуть позже мы реализуем сервис, который у нас будет называться Egress Getaway, который вам позволит получить Мanage NAT instance, т. е. управляемый нами NAT instance со всеми плюшками, который не надо настраивать, а просто можно одной кнопочкой использовать. 

*У нас программисты пишут программу по управлению фитнесом и пользуются Яндекс.Облаком. Как мы можем Terraform использовать и есть ли смысл?*

Например, вы можете в Terraform описать ваш DEF стенд для разработки. У вас, например, каждый разработчик может развернуть себе персональную DEF-версию приложения уже в облаке, уже кластеризованную на несколько зон доступности. И просто переиспользуя это описание, каждый может иметь это себе. Или вы можете один раз описать инфраструктуру и дальше постепенно, используя один и тот же конфигурационный файл, но разные переменные, сделать сначала среду разработки, среду для тестов, для нагрузочных тестов и дальше уже среду для продуктива. Вы можете использовать одно и то же описание конфигурации для различных задач.

*Планируется ли возможность добавления ssh-ключей после создания VM? Будет ли в Web-консоли Web-CLI?*

Вот это два хороших вопроса. Ответ на первый вопрос – да. Мы это сделаем. Наверное, в какое-то ближайшее время эта возможность у нас появится. Следите за новостями. Чуть попозже появится Web-консоль аналогичная Cloud Shell. Нам тоже эта идея очень нравится. Я думаю, мы к этому придем чуть попозже. 

*VPN в виде сервиса планируется или нужно будет самим на серверах разворачивать?*

VPN в виде сервиса планируется чуть позже, чем у нас появится Manage NAT – Egress Getaway, но появится. Я думаю, в этом году это у нас будет. Стоит следить за новостями. А пока – да, пока самим нужно развернуть виртуальную машину, настроить на ней IPsec demon и там настроить этот demon. Наши клиенты настраивают demon StrongSwan. Это вполне себе работает.

Также у нас есть возможность развернуть виртуальную машину в виде образа какого-то сетевого роутера. Пока так. 

### REST API и SDK

Весь функционал Яндекс.Облака, который доступен через веб-интерфейс CLI, Terraform, SDK и REST API, управляется через наш внутренний gRPC API.

![](https://habrastorage.org/webt/d5/yg/bt/d5ygbta1xe81bnidir_eh70drsk.jpeg)

Но самым богатым в плане функциональности для публичных пользователей на текущий момент является REST API. Почему? Потому что жизнь так устроена, что сначала все равно мы пишем API внешний, а потом к нему цепляем наши инструменты. Мы хотим нашим пользователям дать какой-то инструмент с максимальной функциональностью и далее его постепенно расширять. 

И если вам очень часто требуются какие-то продвинутые фишки, которых вдруг нет в интерфейсе CLI, Terraform, SDK, то обратитесь в REST API. Там, скорее всего, оно есть. А если нет, то нам лучше об этом написать, потому что у нас задумано, что REST API – это самый богатый по функциональности инструмент. 

Что такое REST API? REST API – это возможность управлять чем угодно, посылая веб-запросы «GET POST», «DELETE» и т. д. по определенным IP-адресам, которые содержат в себе определенный … . Например, чтобы что-то создать через REST API, надо сделать веб-запрос в наш API. И в этом запросе отправить JSON, в котором описано описание виртуальной машины, которую я хочу создать. Это я вам покажу. 

Для тех, кто не знаком с ним, это кажется чем-то непонятным, но в плане освоения он не настолько сложен. Он, наверное, чуть посложнее в плане восприятия. Я покажу пример. Потом вы можете переиспользовать. И увидите, что ничего страшного тут нет. 

![](https://habrastorage.org/webt/t7/oy/my/t7oymyy-gf2oma5aqkk1lpuebdc.jpeg)

Что мы делаем в рамках REST API? У нас есть задачка, которую я здесь описал. У нас есть сервис балансировщика. Он сейчас у нас находится в alpha, поэтому он у нас может управляться через веб-интерфейс, либо через REST API.

Через веб-интерфейс мы сейчас не хотим делать, потому что нам надо создать сразу несколько виртуальных машин с балансировщиком, поэтому мы можем это все автоматизировать.

Я его пока запущу. Скрипт examples/create_tg.sh. Что мы делаем? Чтобы создать балансировщик, нам сначала надо создать целевую группу.

Документация API очень богата. И она вам поможет для каких-то других вопросов. Здесь у нас описан каждый метод и входы для каждого метода. И вы можете понять, что делать. По каждому методу можно обратиться в документацию и увидеть, что и куда надо направить. 

Я сейчас создал Target Group. Чтобы создать Target Group, мне нужно отправить post HTTP-запрос по этому адресу. А в запросе должен содержаться вот такой JSON. Соответственно, в нем папка, в которой я нахожу имя балансировщика, регион и таргеты. Таргет – это IP-адреса серверов, которые находятся в целевой группе. 

Здесь идет описание того, что обязательно и что необязательно, и как оно должно работать. И по любой задаче всегда можно ссылаться на описание REST API. У каждого сервиса в документации вы найдете внизу описание. Вам скажут, куда, по какому адресу и что оправлять, и что ожидать на входе. Это все достаточно детально описано. 

Что я сейчас сделал? Я сейчас создал JSON, который мне создает Target Group. Отправил его по вот этому адресу. И далее я в Target Group циклом добавил три IP-адреса наших nginx-серверов.

Давайте посмотрим, как это выглядит. Выглядит это следующим образом. Я создал целевые группы. Сервис у нас в alpha, все пока работает не очень стабильно. Но это вопрос к балансировщику. 

Мы создали целевую группу. Examles/create_lb.sh. Теперь мы здесь создаем сам балансировщик. У балансировщика есть имя. Он у нас единственный в зоне доступности. Он пока внешний. Говорим, что нужно слушать на 80-ом порту по протоколу TCP.

Мы ждем, когда он создастся. И далее в него прицепим нашу целевую группу. Мы его прицепили. 

Какие-то вещи вы сразу поймете из интерфейса, потому что, когда вы через веб-интерфейс будете создавать балансировщик и цеплять к нему целевую группу, он вам скажет: «Создай health check, дай ему имя, интервал, все thresholds, на какой порт, по какой страничке». REST API лучше делать после того, как вы познакомились с веб-интерфейсом и понимаете в bash чуть-чуть. 

Мы это все создали, давайте проверим. У нас создался балансировщик. В нем два instances. Важно понимать, что REST API императивный. В этом случае он будет отличаться от Terraform. И чуть дальше расскажу, в чем эта разница заключается. 

Теперь проверим. У нас есть пример, который получает внешний адрес балансировщика, сделав определенный запрос в REST API. И дальше делает определенное число curl.

Мы получили IP балансировщика и сделали 30 веб-запросов, и получили наши имена instances.

Теперь давайте это все удалим.

![](https://habrastorage.org/webt/lc/6a/m1/lc6am1or_lsggdejptsaafqsw-i.jpeg)

Пока это все удаляется, расскажу про SDK. SDK – это набор библиотек сейчас на языках Go и Python для того, чтобы управлять облаком. 

Самый богатый из SDK у нас, наверное, Go, дальше идет Python, потому что SDK мы сами внутри себя используем для решения своих задач.

Для чего нужны SDK? Если вы пишите на этих двух языках и хотите решать какие-то задачи управления облаком на привычном вам языке программирования, то берете и используйте SDK.

Если сравнить по функциональности, то они идентичны. 

И на базе нашего SDK мы как раз пишем коннектор к Terraform.

Они у нас доступны на GitHub, можно открыть. У нас есть наш официальный репозиторий Yandex.Cloud. В нем у нас старая версия провайдера Terraform, но здесь как раз висит ссылочка на Go SDK и Python SDK. Соответственно, здесь описаны его возможности, есть примеры. Он не сильно пока задокументирован. 

Этот репозиторий публичный, если есть желание, то можно коммитить.

Если хочется понять, как выглядят определенные объекты, классы, какие ключи в них правильно вводить и каких типов, то помните, что у нас есть REST API, в котором все достаточно детально описано. 

Пользуйтесь и питоновским и гошным. Пока других языков у нас, к сожалению, не планируется. 

![](https://habrastorage.org/webt/xk/fb/1u/xkfb1unsvwu2vglcpslskmomjlc.jpeg)

Мы сейчас сделаем последнюю демонстрацию по удалению. Сначала я запустил вот этот скрипт, который через REST API посылает команду «DELETE». Он удалит балансировщик и удалит Target Group. А т. к. виртуальные машины и сети созданы у нас через Terraform, то мы здесь можем нажимать «terraform destroy». И он скажет, что у тебя есть три виртуальные машины, три подсети и сеть. И спросит, хочу ли я их удалить. Я говорю ему: «Yes». И он сейчас постепенно-постепенно все это удалит. 

И надо понимать, что если бы я в Terraform сказал: «Увеличь мне число виртуалок», то он бы знал, что у меня есть три виртуалки. А я ему сказал, что теперь должно быть четыре. И он сам из этого состояния перейдет из третьего в четвертое. 

**Отвечаю на ваши вопросы**

*Будет ли возможность подключать Let’s Encrypt сертификаты к балансировщику, чтобы было с автопродлением wildcard?*

По поводу балансировщика и Let’s Encrypt, то в текущей реализации балансировщик, который мы выпустили, это технически L3 балансировщик, но все привыкли к понимаю, что это L4 балансировщик. Т. е. он понимает, что такое TCP/UDP. Что такое SSL, HTTP и HTTPS он, к сожалению, не понимает, поэтому на данный момент в нашем текущем балансировщике, который мы сейчас выпустили, такой возможности нет. Это необходимо делать самостоятельно. 

Из примеров, которые я сейчас видел, пользователи некоторые делают instance group … прокси, и туда загружают сертификат, но я там вопросы с обновлением Let’s Encrypt пока не видел, надо будет уточнить. 

### Сравнение инструментов в Yandex.Cloud

Проведем обзор сравнений всех инструментов. 

![](https://habrastorage.org/webt/hs/n6/1i/hsn61i2bdlwwfdzhgzsssrfv5t8.jpeg)

Было рассказано о многих инструментах управления облаком. Это WEB UI, CLI, Terraform, REST API, SDK. 

У каждого есть свое преимущество:

- Преимущество Web UI – это возможность работы с мобильного устройства. Почему это важно? Потому что бывали у наших пользователей ситуации, когда, например, будучи в метро надо было срочно перезагрузить виртуальную машину. Это быстро и удобно можно сделать через веб-интерфейс. И он понятный, простой в управлении. И с него, наверное, стоит начать знакомство с облаком.  
- CLI – удобный. Он чуть посложнее в управлении. Но те, кто привык работать с командной строкой, часто забывают даже про веб-интерфейс.  
- Преимущества Terraform в том, что он декларативный, т. е. все остальные инструменты, которые описаны у нас в облаке, императивные. Например, через REST API создал целевую группу виртуальных машин, и у меня только два nginx добавилось в нее. Здесь я должен на своей стороне дальше описать логику. Я на своей стороне должен реализовывать обработку ошибок, либо понимать, как из ситуации, когда у меня три виртуальные машины, сделать четыре. Из-за того, что Terraform декларативный, мы можем просто сказать, что я столько-то хочу сетей, столько-то виртуальных машин и с такой-то конфигурацией. И он все за вас это сделает. Это очень удобно. И это основное преимущество, которое можно переиспользовать. Вы опишете инфраструктуру к конфигурационным файлам, вы ее можете запустить с другого места, либо просто поменять в ней переменные. И вы будете уверены, что все будет работать один в один.  
- REST API самый богатый по функциональности. У вас могут случится ситуации, когда функционал доступен только через REST API. В любом случае стоит освоить его возможности через curl, либо Postman, если вы хотите работать с нашим облаком для того, чтобы вы решали свои задачи вовремя, поэтому максимально весь функционал отдаем в REST API.  
- Но если вы привыкли что-то писать на Go и на Python, то, возможно, SDK – это ваш выбор.  

![](https://habrastorage.org/webt/s6/mf/7v/s6mf7vvdis3skh98oumsbgxcqbq.jpeg)

Мало взять и создать виртуальную машину. Она сама по себе никому не нужна. На нее надо какое-то приложение поставить. У нас есть сервис метаданных, который что-то позволяет установить. 

И также в Terraform есть такая штука, которая называется provisioners. Это инструмент Terraform, который при создании виртуальной машины, зайдет на нее по ssh и какой-то скрипт выполнит. Это тоже очень удобно. 

Мы общаемся с разными пользователями, и каждый пользователь выбирает инструмент исходя из того, что ему удобнее. 

**Отвечаю на ваши вопросы**

*Как интегрировать Ansible и Terraform?*

По поводу Ansible. Ansible умеет запускать Terraform. И с помощью Terraform можно запускать Ansible. Там очень много есть удобных и понятных интеграций. Стоит посмотреть этот вебинар и понять, что они друг с другом отлично работают. Перейдите по ссылке Григория, посмотрите вебинар. Там очень классно все описано в плане того, как это делать.

Вопрос также был по поводу создания образов. У нас в планах есть реализация коннектора к инструменту Packet. Это тоже инструмент компании HashiCorp, который позволяет создавать свои образы. Мы сейчас как раз с Terraform прошли эту историю. Сделали официального провайдера. Чуть позже у нас выйдет интеграция с Packet, которая позволит вам в виде конфигурационного файла описать образ. 

И Packet нативно интегрирован с Ansible. Здесь тоже можно сделать образ, в него Ansible весь конфиг запушит и все будет работать.

И через какое-то время выйдет наш функционал, который будет называться Фанкшенс. Это очень хороший сервис, который можно использовать для задач автоматизации самого облака. Следите за новостями. Постепенно будем расширять набор для разработки, постепенно будем расширять наши инструменты: и Terraform, и CLI.

*Есть ли планы по поводу Terraform inventory?*

Давайте мы это тоже возьмем на заметку и посмотрим сможем ли мы это реализовать.

*Можно ли поподробнее рассказать про динамические изменения ресурсов виртуальной машины, например, изменение количества процессоров, памяти на ходу?*

У нас есть фичреквест от определенного набора пользователей. Сейчас этого нет. Не могу точно сказать, когда оно появится, но лучше следить за новостями. Если вы сейчас работаете с нашим облаком, то лучше делать такую логику, которая позволяет вам делать это на ходу. 

В instance groups такого нет. В instance groups вы описываете размер. В instance groups нельзя на ходу менять. В instance groups вы просто описываете ваш размер виртуальной машины целевой. И она автоматически изменяет размеры, делая операцию типа rolling update. Она просто делает это так, чтобы у вас изменение не повлияло на доступность вашего сервиса. 

Здесь мало у кого это реализовано из облачных провайдеров. Это реализовано только у тяжелых enterprise вендоров, которые большие компании себе покупают. И тут просто переписав логику работы вашей инфраструктуры, вы можете и без этого решать задачу scaling вверх. Но и всегда есть и горизонтальный scaling. Стоит это учитывать.

И также надо понимать по поводу изменения размеров наших управляемых баз данных, там процедура rolling update позволяет вам без остановки базы делать scaling вверх. Посмотрите, на наши сервисы: Manage Postgres, ClickHouse и MongoDB, которые сейчас в G, и остальные сервисы, которые в alpha. В них у вас такая возможность есть, но она делается через rolling update. И мы снова гарантируем, что не будет простоя сервиса. 

По завершению вебинара пройдитесь по ссылке в репозитории, пройдите по всем заданиям, ознакомьтесь с инструментами, используйте их. Пройдите обучение по Terraform на сайте Terraform. Это все делается быстро и просто. И дальше пользуйтесь нашим облаком. 

